<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>liza</title>
	<meta name="viewport" content="width=device-width", initial-scale=1.0, user-scalable=no>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<link rel="preload" href="img/Inkfree.ttf" as="font" type="font/ttf" crossorigin>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>	
	<script src="lib/wgl/three.min.js"></script>
	<script src="lib/wgl/ColladaLoader.js"></script>
	<script src="lib/wgl/OrbitControls.js"></script>
	<script src="lib/wgl/OutlineEffect.js"></script>
	<script src="blackboard.js"></script>
	<script src="voice.js"></script>
	
	<style>
		 body { 			font-family:Verdana,Geneva,sans-serif;font-size:13px; box-sizing:border-box; 
							padding:0;margin:0; position: fixed; width:100%;
							}
		.lz-splash { 		color:#999; text-align:center; margin-top:10%;  display:none;
							}
		.lz-about { 		position: relative; width:100%; max-width:800px; height:calc(100vh - 28px); margin: 12px auto; border:none; 
							}
		.lz-main { 			width:100%; height:100%; background-color: #ddd; display:none; text-align:center;
							}
		.lz-error { 		position: absolute; top:16px; left:19px;
							}
		.lz-controller {	position: fixed; top: calc(100% - 39px); left:0; background-color: #aaa; border: 1px solid #999;
							padding:6px 12px; width: calc(100% - 24px); height:25px;  display:none;
							}
		.lz-dialog {		position: absolute; top:16px; left:16px; background-color: #eee; border: 1px solid #aaa;
							padding:16px; border-radius: 16px; width: 600px;
							}
		.lz-blackboard {	position: absolute; left:16px; top: calc(100vh - 336px); width: 550px; height: 256px;  display:none;
							background-color: #999; border: 1px solid #999;	padding:12px; border-radius: 8px; 
							}
		.lz-canvas {		position: absolute; left:50px; top: 12px; width: 512px; height:256px; border-radius: 4px; 
							}
		.lz-confirm {		position: absolute;  width: 300px; padding: 16px; left: calc(50% - 150px); top: calc(50% - 50px); user-select: none;	
							border-radius: 8px; background-color: #fff; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							}
		.lz-popup {			position: absolute;  width: auto; padding: 12px; left: calc(50% - 100px); top: calc(50% - 50px);
							border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							font-size: 14px; text-align:center; display: none;
							}
		.lz-prompt {		color:#fff; width:100%;	vertical-align: 3px; margin-left:16px; font-size:16px;
							}
		.lz-is {			border-radius:16px; padding:0 8px; width:200px; height: 24px;
							border:1px solid #999; font-size: 13px;
							}
		.lz-bs {			cursor: pointer; color:#fff; 
							text-align: center; border-radius: 16px; display: inline-block; user-select: none;
							font-size: 12px; background-color: #27ae60; padding: 2px 8px 2px 8px; vertical-align:3px;
							}

		 table {			border-spacing: 0px;  }

		 @font-face {  		font-family: Chalk; src: url(img/Inkfree.ttf);   }

</style>
</head>
<body>
	
	<div id="mainDiv" class="lz-main"></div>
	<div id="splashDiv" class="lz-splash">
		<img src="img/lizalogo.png" style='width:25%;opacity:.66;' alt=""><br><br>
		<br><p style="color:#000;font-size:14px"><em>A tool for engaging people in highly affective script-driven discourse<br>for learning and practicing goal-directed behaviors.</em></p>
		<br><br><div id='startBut' class='lz-bs' onclick='app.voice.Talk("hello")'>Start</div>
	</div>
	<div id="controllerDiv" class="lz-controller">
		<span id="talkSpan">
			<img id="talkBut" src="img/talkbut.png" title="Click to talk" style="cursor:pointer">
		</span>
		<img id="writeBut" src="img/editbut.gif" title="Draw on blackboard" style="cursor:pointer;margin-left:24px">
		<span id='promptSpan' class='lz-prompt'></span>

		<img id="helpBut" src="img/helpicon.gif" style="cursor:pointer;margin-right:4px;float:right">
		<img id="settingsBut" src="img/settingsbut.gif" title="Settings" style="cursor:pointer;margin-right:16px;float:right">
	</div>
	<div id='blackboardDiv' class='lz-blackboard'>
		<br><img id="BB-DrawBut" src="img/line-icon.png" style="cursor:pointer;margin-bottom:12px;;margin-top:-12px" title="Draw"><br>
		<img id="BB-EraseBut" src="img/eraser-icon.png" style="cursor:pointer;margin-bottom:12px" title="Erase"><br>
		<img id="BB-TextBut" src="img/text-icon.png" style="cursor:pointer;margin-bottom:12px" title="Text"><br>
		<img id="BB-ImageBut" src="img/image-icon.png" style="cursor:pointer;margin-bottom:60px" title="Pics"><br>
		<img id="BBClearBut" src="img/trash-icon.png" style="cursor:pointer;margin-bottom:4px" title="Clear all">
		<div id="BBSideBut" style="cursor:pointer;color:#fff;font-size:11px;margin-left:-5px" title="Side">&nbsp;LEFT</div>
		<canvas id="blackboardCan-0" height=256 width=512 class='lz-canvas' tabindex='1'></canvas>
		<canvas id="blackboardCan-1" height=256 width=512 class='lz-canvas' tabindex='1'></canvas>
		</div>
<script>

var app=null;																					// Holds app
var isMobile=false;																				// Flag for mobile devices

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																					

	constructor(id)   																			// CONSTRUCTOR
	{
		app=this;
		this.bb=new Blackboard();																	// Make bb		
		this.arc=new ARC();																			// Make new ARC tree		
		this.arc.Load("1ez3sEcWaNk9QgoRRGn5BOQYj541wBcrx8Es2ClJMmbU");								// Load from Google doc
		this.sc=new Scene("mainDiv");																// Make new scene		
		this.voice=new Voice(this.OnPhrase);														// Alloc TTS/STT
		this.parser=new Parser();																	// Alloc AI parser		
		this.poses=[];																				// Holds poses
		this.seqs=[];																				// Holds pose sequences
		this.desks=[];																				// Holds desks	
		this.animateData=[];																		// Holds animation data
		this.students=[];																			// Holds students	
		this.record=[];																				// Holds record of actions
		this.LoadProject("myFile");																	// Load project file
		this.LoadModels();																			// Load 3D models
		this.Draw();																				// Start 
		this.startTime=new Date().getTime();														// Session start time
		this.inPlayback=false;																		// In playback mode?
		if (!this.voice.hasRecognition) 															// This platform doesn't have voice recognition
			$("#talkSpan").html("<input id='talkInput' type='text' class='lz-is' style='vertical-align:4px' placeholder='Talk by typing here'>");	// Put in text input field
		$("#settingsBut").on("click", ()=> { app.sc.PoseEditor();  });								// On settings button click	
		$("#talkBut").on("click", ()=> { app.voice.Listen(); });									// On talk button click, start listening
		$("#helpBut").on("click", ()=> { app.ShowHelp(); });										// On help button click, show help
		$("#writeBut").on("click", ()=> { 															// On BB button clck
			var m=$("#blackboardDiv").css("display") == "none" ? 1 : 0;								// Hide or show
			$("#blackboardDiv").toggle("slide",{ direction:"down"}) 								// Slide
			this.AddToRecord({ o:'B', m:m }); 														// Add to record
			}); 
		$("#talkInput").on("click",  function() { $(this).focus() });								// On click, set focus
		$("#talkInput").on("change", function() { app.OnPhrase( $(this).val()), $(this).val("") });	// On enter, act on text typed
		$("body").on("keydown", (e)=> {																// On key hit
			if ((e.target == document.body) && (e.keyCode == 32) && this.voice.hasRecognition)		// Spacebar in body
				 app.voice.Listen();																// Start listening	
			});															
	}

	LoadProject(file)																			// LOAD PROJECT DATA
	{
		var tex=this.sc.cartoonScene ? 0xffffff : "lib/wgl/map.jpg";								// Desks cartoon or real				
		this.desks.push({ id:"desk1", src:"assets/desk.dae", x:-120, y:-100, z:0, s:20, r:0, tex:tex} );	
		this.desks.push({ id:"desk2", src:"assets/desk.dae", x:0, y:-100, z:0, s:20, r:0, tex:tex} );		
		this.desks.push({ id:"desk3", src:"assets/desk.dae", x:120, y:-100, z:0, s:20, r:30, tex:tex} );		
		this.desks.push({ id:"desk4", src:"assets/desk.dae", x:-120, y:100, z:0, s:20, r:-10, tex:tex} );		
		this.desks.push({ id:"desk5", src:"assets/desk.dae", x:0, y:100, z:0, s:20, r:0, tex:tex} );		
		this.desks.push({ id:"desk6", src:"assets/desk.dae", x:120, y:100, z:0, s:20, r:0, tex:tex} );		
		if (!window.location.search.match(/one/i)) {
			this.students.push({ id:"freddy", src:"assets/body.dae", x:-120, y:-112, z:0, s:15, r:0, tex:this.sc.cartoonScene ? "assets/freddyskin.png" : "assets/skin1.png", sex: "male", fidget:0} );
//			this.students.push({ id:"joe", src:"assets/body.dae", x:0, y:-112, z:0, s:15, r:0, tex:this.sc.cartoonScene ? "assets/joeskin.png" : "assets/skin1.png", sex: "male", fidget:0 } );
//			this.students.push({ id:"sally", src:"assets/body.dae", x:120, y:-112, z:1, s:15, r:0, tex:this.sc.cartoonScene ? "assets/sallyskin.png" : "assets/skin1.png", sex: "female", fidget:0 } );
			this.students.push({ id:"sara", src:"assets/body.dae", x:-120, y:88, z:0, s:15, r:-10, tex:this.sc.cartoonScene ? "assets/saraskin.png" : "assets/skin1.png", sex: "female", fidget:0 } );
			this.students.push({ id:"robert", src:"assets/body.dae", x:0, y:88, z:0, s:15, r:0, tex:this.sc.cartoonScene ? "assets/robertskin.png" : "assets/skin1.png", sex: "male", fidget:0 } );
			}
		this.students.push({ id:"liza", src:"assets/body.dae", x:120, y:88, z:1, s:15, r:0, tex:this.sc.cartoonScene ? "assets/lizaskin.png" : "assets/skin1.png", sex: "female", fidget:0 } );
		
		this.poses["startUp"]="armL,-51,4,-44,armR,-51,-4,44,base,0,0,0,chest,0,0,0,fingersL,0,0,0,fingersR,0,0,0,forearmL,0,0,-45,forearmR,0,0,47,legL,82,0,0,legR,83,0,0,mouth,0,0,0,neck,0,0,0,shoulderL,0,0,0,shoulderR,0,0,0,spine,0,0,0,thighL,-78,-8,0,thighR,-78,10,0,thumbL,0,0,0,thumbR,0,0,0,wristL,0,-50,0,wristR,8,0,0";
		this.poses["mouthOpen"]="mouth,8,0,0";			this.poses["mouthClosed"]="mouth,0,0,0";
		this.poses["headUp"]="neck,0,0,0";				this.poses["headDown"]="neck,16,0,0";	this.poses["heaBack"]="neck,-16,0,0";
		this.poses["headLeft"]="neck,0,20,0";			this.poses["headRight"]="neck,0,-20,0"; this.poses["headCenter"]="neck,0,0,0";
		this.poses["leftLegStretch"]="legL,50,0,0";		this.poses["leftLegSit"]="legL,90,0,0";	
		this.poses["rightLegStretch"]="legR,50,0,0";	this.poses["rightLegSit"]="legR,90,0,0";	
		this.poses["leftArmDesk"]="armL,-60,0,-45,forearmL,0,0,-46";			this.poses["rightArmDesk"]="armR,-60,0,45,forearmR,0,0,46";
		this.poses["handUp"]="armL,25,0,0,forearmL,68,-25,0,wristL,0,-40,0";	this.poses["handDown"]="armL,-51,0,-44,forearmL,0,0,-45,wristL,0,0,0";	
		this.poses["handRight"]="forearmL,50,-25,0";	
		this.poses["twistLeft"]="neck,0,30,0,spine,0,33,0";						this.poses["twistRight"]="neck,0,-30,0,spine,0,-60,0";			
		this.poses["sleep"]="neck,45,62,0,chest,49,0,0,armL,-12,53,0,wristL,0,0,0,forearmL,120,-58,9,armR,0,30,0,forearmR,-90,0,0,wristR,0,0,0";
		this.poses["standUp"]="armL,-80,0,0,armR,-80,0,0,legL,0,0,0,legR,0,0,0,thighL,0,0,0,thighR,0,0,0,forearmL,0,0,0,forearmR,0,0,0,chest,0,0,0,base,50,0,0";
			
		this.seqs["sleep"]="sleep,1";
		this.seqs["standUp"]="standUp,1";
		this.seqs["sit"]="startUp,1";
		this.seqs["wave"]="handUp,.6,handRight,.5,4";
		this.seqs["nodYes"]="headBack,.6,headDown,.5,headUp,.5,2";
		this.seqs["nodNo"]="headLeft,.3,headRight,.3,headCenter,.3,2";
		this.seqs["headUp"]="headUp,1";			this.seqs["headDown"]="headDown,1";			
		this.seqs["headLeft"]="headLeft,1";		this.seqs["headRight"]="headRight,1";
		this.seqs["armUp"]="handUp,1";			this.seqs["armDown"]="leftArmDesk,1";
		this.seqs["twistLeft"]="twistLeft,1";	this.seqs["twistRight"]="twistRight,1";
		this.curStudent=this.students.length-1;
	}

	LoadModels() 																				// LOAD 3D MODELS
	{
		var i;
		for (i=0;i<this.desks.length;++i)  		this.sc.AddModel(this.desks[i]);					// Load each desk		
		for (i=0;i<this.students.length;++i)  	this.sc.AddModel(this.students[i]);					// Load each student		
	}

	Draw() 																						// REDRAW
	{
		this.sc.Render();																			// Render scene and animate
	}

	ShowHelp() 																					// SHOW HELP
	{
		if ($("#helpDiv").length) {																// If already up, bring it down
			$("#helpDiv").hide("slide",{ direction:"down", complete: ()=>{ $("#helpDiv").remove(); } }); // Slide down
			return;																				// Quit																					
			}
		var str="<div id='helpDiv' class='lz-dialog'style='height:calc(100vh - 106px);display:none;'>";
		str+="<img src='img/lizalogo.png' style='vertical-align:-6px' width='64'><span style='font-size:18px;margin-left:8px'>"
		str+="help</span><img src='img/closedot.gif' style='float:right' onclick='$(\"#helpDiv\").remove()'><br><br>";	
		str+="<iframe src='https://docs.google.com/document/d/e/2PACX-1vTXAsMJ-YlQaNtT49RtKvEnT5v5Xzz-TKPyVlo2px-23vDt-4lZFB7JujSKyDXs38hiSMISQoulYXB5/pub?embedded=true' ";
		str+="style='border: 1px solid #999;width:100%;height:calc(100vh - 154px)'></iframe></div>";
		$("body").append(str);																	// Add to body
		$("#helpDiv").show("slide",{ direction:"down" });										// Slide up
		if (!isMobile)	$("#helpDiv").draggable();												// Make it draggable on desktop
		$("#helpDiv").on("mousedown touchdown touchmove", (e)=> { e.stopPropagation() } );		// Don't move orbiter
		}

	OnPhrase(text, playingBack) 																// ON PHRASE UTTERED
	{
		trace(text)
		var hasAction=false;
		app.AddToRecord({ o:'S', w:text });															// Add to recording if not playing back
		if (app.voice.talking == 1)  return;														// Not while student is talking																
		app.parser.Parse(text, (o)=> {																// Parse text
			if (o.student) {																		// If a student mentioned
				if (o.student[0].v.match(/liza/i)) 			app.curStudent=3;						// Set current student
				else if (o.student[0].v.match(/freddy/i)) 	app.curStudent=0;
				else if (o.student[0].v.match(/robert/i)) 	app.curStudent=2;
				else if (o.student[0].v.match(/sara/i)) 	app.curStudent=1;
				}
			if (o.action)  																			// If an action mentioned
				hasAction=app.DoAction(o.action[0].v)												// Try to do action
			if (!hasAction)																			// If no action
				app.ParseDialog(text);																// Try to parse text directly
			});																		
		}
		
		DoAction(act)																			// PERFORM ACTION
		{
			var mod=app.students[app.curStudent].id;												// Get model id
			if (act.match(/sleep/i))	 					 		app.sc.StartAnimation(mod,app.seqs["sleep"]);								
			else if (act.match(/sit/i))	 							app.sc.StartAnimation(mod,app.seqs["sit"]);							
			else if (act.match(/head/i)		&& act.match(/up/i)) 	app.sc.StartAnimation(mod,app.seqs["headUp"]);								
			else if (act.match(/head/i) 	&& act.match(/down/i)) 	app.sc.StartAnimation(mod,app.seqs["headDown"]);									
			else if (act.match(/head/i)		&& act.match(/left/i)) 	app.sc.StartAnimation(mod,app.seqs["headLeft"]);								
			else if (act.match(/head/i)		&& act.match(/right/i))	app.sc.StartAnimation(mod,app.seqs["headRight"]);								
			else if (act.match(/twist/i)	&& act.match(/left/i)) 	app.sc.StartAnimation(mod,app.seqs["twistLeft"]);								
			else if (act.match(/twist/i)	&& act.match(/right/i)) app.sc.StartAnimation(mod,app.seqs["twistRight"]);								
			else if (act.match(/hand/i) 	&& act.match(/up/i)) 	app.sc.StartAnimation(mod,app.seqs["armUp"]);								
			else if (act.match(/hand/i) 	&& act.match(/down/i)) 	app.sc.StartAnimation(mod,app.seqs["armDown"]);								
			else if (act.match(/nod/i)	 	&& act.match(/yes/i)) 	app.sc.StartAnimation(mod,app.seqs["nodYes"]);								
			else if (act.match(/nod/i)	 	&& act.match(/no/i)) 	app.sc.StartAnimation(mod,app.seqs["nodNo"]);								
			else if (act.match(/fidget/i) 	&& act.match(/stop/i)) 	app.students[app.curStudent].fidget=0;							
			else if (act.match(/fidget/i))							app.students[app.curStudent].fidget=1;							
			else if (act.match(/wave/i))							app.sc.StartAnimation(mod,app.seqs["wave"]);						
			else if (act.match(/stand/i))							app.sc.StartAnimation(mod,app.seqs["standUp"]);								
			else if (act.match(/say/i))	 							app.voice.Talk("My name is "+mod+". How are you today?");						
			else 													return false;					// Return not handled
			return true;																			// Return andled		
		}

	ParseDialog(text) 																				// PARSE DIALOG
	{
		if (text.match(/what/i)) {
			if (text.match(/2.*\+.2*/i))			app.voice.Talk("2 + 2 = 4");
			else if (text.match(/4.*\+.* 4/i))		app.voice.Talk("4 + 4 = 8");
			else if (text.match(/time is it/i))		app.voice.Talk("It is now time for all men to come to the aid of their country.");
			}
		else if (text.match(/replay/i) && text.match(/class/i))	app.record.pop(),app.Playback();
		else if (text.match(/who/i) && text.match(/knows/i)) {
			var i=Math.floor(Math.random()*app.students.length);	
			app.curStudent=i;
			app.voice.Talk("I do, I do, it's "+app.students[i].id+", please choose me!");
			app.sc.StartAnimation(app.students[i].id,app.seqs["wave"]);
			}
		else if (text.match(/sure/i))				app.voice.Talk("Yes I am sure.")
		else if (text.match(/final/i))				app.voice.Talk("Yes, this is my final answer.")
		else 										Prompt("Huh? - "+text);
	}

	AddToRecord(data)																				// ADD ACTION TO RECORD
	{
		if (this.inPlayback) {																			// Playing back
			if (data.o == 'S')	app.voice.Talk(data.w,true);											// Speak as instructor
			return;																						// Don't add
			}
		data.t=new Date().getTime();																	// Capture time
		app.record.push(data);																			// Add to array																	
	}

	Playback()																						// PLAYBACK ACTION IN RECORD
	{
		var i,o,now,s=0;
		var sTimer=setInterval(actions,2);																// Set time
		this.inPlayback=true;																			// In playback mode
		this.sc.SetCamera(0,150,500,-.291457,0,0);														// Reset camera
		for (i=0;i<this.students.length;++i)															// For each student
			this.sc.SetPose(this.students[i].id,"startUp",20);											// Return to startup pose
		app.bb.Playback({ o:'B', s:0, m:0 });															// Close bb editor, set to left side
		app.bb.Playback({ o:'C', s:0 }); app.bb.Playback({ o:'C', s:1 });								// Clear bbs																		
		var off=new Date().getTime()-this.startTime;													// Get offset from 1st event
		function actions() {																			// PERFORM ACTIONS IN RECORD
			if (s >= app.record.length)	{																// If done
				clearInterval(sTimer);																	// Kill timer
				app.inPlayback=false;																	// In normal mode
				return;
				}
			now=new Date().getTime()-off;																// Get now
			for (i=s;i<app.record.length;++i) {															// For each action
				o=app.record[i];																		// Point at segment
				if (now < o.t) 		break;																// If before time of action quit
				if (now >= o.t)		++s;																// Done this one
				if (o.o == 'S')		app.OnPhrase(o.w,true);												// Speaking if S
//				if (o.o == 'O')		app.sc.SetCamera(o.x,o.y,o.z,o.xr,o.yr,o.zr);						// Move camera if O
				else				app.bb.Playback(o);													// Draw segment	if B, M, D, E, U, T, X, P, or C		
				}
			}	
	}

} // App class closure





///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ARC
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class ARC  {																					

	constructor()   																				// CONSTRUCTOR
	{
		this.tree=[];
	}

	Load(id) 																						// LOAD DOC FROM GOOGLE DRIVE
	{
		var _this=this;																					// Save context
		var str="https://docs.google.com/spreadsheets/d/"+id+"/export?format=tsv";						// Access tto
		var xhr=new XMLHttpRequest();																	// Ajax
		xhr.open("GET",str);																			// Set open url
		xhr.onload=function() { 																		// When loaded
			var i,o,v;
			this.tree=[];																				// Clear tree
			var tsv=xhr.responseText.replace(/\\r/,"");													// Remove CRs
			tsv=tsv.split("\n");																		// Split into lines
			for (i=1;i<tsv.length;++i) {																// For each line
				v=tsv[i].split("\t");																	// Split into fields
				if (v[1] == "A") 			  o=_this.tree[v[0]]={ text:v[2], res:[], con:[] };			// A new ARC
				else if (v[1].match(/R\+/i))  o.res.push({ text:v[2], type:1 } );						// Right response
				else if (v[1].match(/R\-/i))  o.res.push({ text:v[2], type:-1 } );						// Wrong 
				else if (v[1].match(/C\+/i))  o.con.push({ text:v[2], type:1, next: v[3] } );			// Right consequence
				else if (v[1].match(/C\-/i))  o.con.push({ text:v[2], type:-1, next: v[3] } );			// Wrong
				else if (v[1].match(/C\?/i))  o.con.push({ text:v[2], type:0, next: v[3] } );			// None
				}
			};									
		xhr.send();																						// Do it
		
		xhr.onreadystatechange=function(e) { 															// ON AJAX STATE CHANGE
			if ((xhr.readyState === 4) && (xhr.status !== 200)) {  										// Ready, but no load
				Sound("delete");																		// Delete sound
				PopUp("<p style='color:#990000'><b>Couldn't load Google Doc!</b></p>Make sure that <i>anyone</i><br>can view it in Google",5000); // Popup warning
				}
			};		
		}


} // ARC class closure



///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// 3D SYSTEM
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class Scene {																				 

	constructor(div)																				// CONSTRUCTOR
	{
		this.cartoonScene=window.location.search.match(/real/i) ? false : true;						// Render scene as cartoon?	   		
		this.models=[];																				// Holds models
		this.container=$("#"+div)[0];																// Div container														
		this.camera=null;																			// Camera object
		this.renderer=null;																			// Renderer object
		this.scene=null;																			// Scene object
		this.controls=null;																			// Controls object
		this.outliner=null;																			// Outline renderer
		this.floor="assets/wood.jpg";																// Floor texture
		this.backWall="assets/blackboard.png";														// Back wall texture
		this.frontWall=this.cartoonScene ? "" : "assets/blackboard.png";							// Front wall texture
		this.leftWall= this.cartoonScene ? "" : "assets/windowwall.png";							// Side wall texture
		this.rightWall=this.cartoonScene ? "" : "assets/windowwall.png";							// Side wall texture
		this.aniTimer=0;																			// Timer for talking and fidgeting
		this.Init();																				// Init 3D system
		}

	Init()																						// INIT 3D SYSTEM
	{
		this.scene=new THREE.Scene();																// Alloc new scene
		if (this.cartoonScene) 	this.scene.background=new THREE.Color(0xffffff);					// White background
		this.manager=new THREE.LoadingManager();													// Loading manager
		this.textureLoader=new THREE.TextureLoader();												// Texture loader
		this.AddCamera(0,150,500,.4);																// Add camera
		this.controls.addEventListener('end',(e)=> {												// On control change
			app.AddToRecord( {o:'O',																// Add to record
				xr:this.camera.rotation.x, yr:this.camera.rotation.y, zr:this.camera.rotation.z,	// Rotation
				x:this.camera.position.x,  y:this.camera.position.y,  z:this.camera.position.z});	// Position
				});
		this.renderer=new THREE.WebGLRenderer({ antialias: true });									// Init renderer
		this.renderer.setPixelRatio(window.devicePixelRatio);										// Set ratio
		this.AddLights();																			// Add lights
		this.Resize();																				// Resize 3D space
		this.container.appendChild(this.renderer.domElement);										// Add to div
		this.AddRoom();																				// Add room walls
		this.AddBlackboards();																		// Add blackboards
	}

	AddLights()																					// ADD LIGHTS
	{
		var light=new THREE.DirectionalLight("#222222");											// Made directional light
		light.position.set(0,0,1);																	// Set angle
		this.scene.add(light);																		// Add directioal light
		this.scene.add(new THREE.AmbientLight(0xffffff, 1));										// Add ambient light
		this.outliner=new THREE.OutlineEffect(this.renderer, { /*defaultThickness:.0035 */ });		// Add outliner
	}

	Resize()																					// RESIZE 3D SPACE
	{
		this.camera.aspect=window.innerWidth/window.innerHeight;									// Set aspect
		this.camera.updateProjectionMatrix();														// Reset matrix
		if (this.scene && this.scene.outliner) 	this.outliner.setSize(window.innerWidth,window.innerHeight-3);	// Reset render size		
		else if (this.scene)					this.renderer.setSize(window.innerWidth,window.innerHeight-3);	
	}

	AddCamera(x, y, z)																			// ADD CAMERA
	{
		this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2000);	// Add 45 degree POV
		this.scene.add(this.camera);																// Add camera to scene
		this.SetCamera(x,y,z,0,0,0);																// Position camera
		this.controls=new THREE.OrbitControls(this.camera);											// Add orbiter control
		this.controls.damping=0.2;																	// Set dampening
	}

	SetCamera(x, y, z, xr, yr, zr)																	// SET CAMERA
	{
		this.camera.position.x=x;	this.camera.position.y=y;	this.camera.position.z=z;			// Camera position
		this.camera.rotation.x=xr;	this.camera.rotation.y=yr;	this.camera.rotation.z=zr;			// Rotation
	}

	AddRoom()																					// ADD ROOM TO SCENE
	{	
		var _this=this;																				// Save context
		if (this.floor) 		addWall(0,0,0,-Math.PI/2,0,0,1024,this.floor,1,this.cartoonScene);	// If a floor spec'd
		if (this.frontWall) 	addWall(0,128,512,0,Math.PI,0,256,this.frontWall,0,0);				// If a front wall spec'd
		if (this.backWall) 		addWall(0,128,-512,0,0,0,256,this.backWall,0,0);					// If a back wall spec'd
		if (this.leftWall) 		addWall(-512,128,0,0,Math.PI/2,0,256,this.leftWall,0,0);			// If a left wall spec'd
		if (this.rightWall)	 	addWall(512,128,0,0,-Math.PI/2,0,256,this.rightWall,0,0);			// If a right wall spec'd

		function addWall(x, y, z, xr, yr, zr, h, texture, wrap, cartoon) {							// ADD WALL
			var mat=new THREE.MeshPhongMaterial();													// Make material
			mat.color=new THREE.Color(cartoon ? 0xeeeeee : 0xffffff);								// Set color
			if (!cartoon) {																			// If a cartoon scene
				mat.userData.outlineParameters= { visible: false };									// Hide outline
				var tex=_this.textureLoader.load(texture);											// Load texture
				if (wrap) {																			// If wrapping
					tex.wrapS=tex.wrapT=THREE.RepeatWrapping;										// Wrap and repeat
					tex.repeat.set(4,4);															// 4 by 4
					}
				mat.map=tex;																		// Add texture
				}
			var cbg=new THREE.PlaneGeometry(1024,h,1,1);											// Make grid
			var mesh=new THREE.Mesh(cbg,mat);														// Make mesh
			mesh.rotation.x=xr;		mesh.rotation.y=yr;		mesh.rotation.z=zr;						// Rotate 
			mesh.position.x=x; 		mesh.position.y=y;		mesh.position.z=z;						// Position
			_this.scene.add(mesh);																	// Add to scene		
		}
	}

	AddBlackboards()																			// ADD BLACKBOARDS TO WALL
	{
		var mat=new THREE.MeshPhongMaterial();														// Make material
		var cbg=new THREE.PlaneGeometry(256,128,1);													// Make grid
		var mesh=new THREE.Mesh(cbg,mat);															// Make mesh
		app.bb.texMap[0]=mat.map=new THREE.CanvasTexture($("#blackboardCan-0")[0]);					// Left blackboard
		mesh.position.x=-200; 		mesh.position.y=150;		mesh.position.z=-511;				// Position
		this.scene.add(mesh);																		// Add to scene		
		mat=new THREE.MeshPhongMaterial();															// Make material
		cbg=new THREE.PlaneGeometry(256,128,1);														// Make grid
		mesh=new THREE.Mesh(cbg,mat);																// Make mesh
		app.bb.texMap[1]=mat.map=new THREE.CanvasTexture($("#blackboardCan-1")[0]);					// Left blackboard
		mesh.position.x=200; 		mesh.position.y=150;		mesh.position.z=-511;				// Position
		this.scene.add(mesh);																		// Add to scene		
	}

	AddModel(o)																					// ADD MODEL TO SCENE
	{
		var loader;
		var _this=this;																				// Save context
		if (o.src.match(/\.json/i))	loader=new THREE.ObjectLoader(this.manager);					// If JSON model format
		if (o.src.match(/\.obj/i))	loader=new THREE.OBJLoader(this.manager);						// If OBJ
		if (o.src.match(/\.gltf/i))	loader=new THREE.GLTFLoader(this.manager);						// If GLTF
		if (o.src.match(/\.dae/i))	loader=new THREE.ColladaLoader(this.manager);					// If DAE

		loader.load(o.src, (obj)=> { 																// Load model
			loadModel(obj);																			// Load it
			if (o.sex) 				_this.SetPose(o.id,"startUp");									// If a student set starting pose
			if (o.id == "liza") 	_this.SetPose(o.id,"handUp");									// Raise hand											
			}, onProgress, onError );																// Load

		function onProgress(xhr) {}																	// ON PROGRESS

		function onError(err) {	console.log(err) };													// ON ERROR

		function loadModel(object) {															// ON LOAD
			var i=0,texture=null;
			if (object.scene)	object=object.scene;												// Point at scene if there (GLTF/DAE)			
			_this.models[o.id]=({ name:o.src, bones:[], model: object });							// Add new model	
			var cm=_this.models[o.id];																// Point at new model
			if (o.tex && isNaN(o.tex)) 																// If a texture
				texture=_this.textureLoader.load(o.tex);											// Load it

			object.traverse(function(child) {														// Go thru model
				if (child.isBone) {																	// If a bone,
					cm.bones[child.name]=child; 													// Add to list
					child.oxr=child.rotation.x;														// Save original x rotation
					child.oyr=child.rotation.y;														// Y
					child.ozr=child.rotation.z;														// Z
					}
				if (child.isMesh) { 																// If a mesh
					if (texture)		child.material.map=texture;									// If has texture, add it
					if (!isNaN(o.tex)) 																// If a cartoon shading
						child.material.color=new THREE.Color(o.tex);								// Set color
					if (child.material.userData)													// If user data
						child.material.userData.outlineParameters= { visible:app.sc.cartoonScene }; // Outline if cartoon
					}							
			});
			
			object.oxp=o.x;		object.ozp=o.y;		object.oyp=o.z;	object.orp=o.r;					// Save start pos's
			object.scale.x=object.scale.y=object.scale.z=o.s;										// Scale 
			object.position.x=o.x;	object.position.z=o.y;	object.position.y=o.z;					// Position
			object.rotation.z=o.r*Math.PI/180;														// Rotation
			_this.scene.add(object);																// Add model to scene
		}
	}

	SetBone(model, bone, x, y, z)																// ROTATE A BONE
	{
		if (!this.models[model] || !this.models[model].bones[bone])	return;							// Quit on bad model or bone
		if (bone == "base") {																		// X and Z axes set model positon directly, not via the bone
			this.models[model].model.position.x=x-0+this.models[model].model.oxp;					// Set base X position via model
			this.models[model].model.position.z=z-0+this.models[model].model.ozp;					// Z
			x=z=0;
			}
		x*=Math.PI/180;	y*=Math.PI/180;	z*=Math.PI/180;												// Convert degrees to radians
		x+=this.models[model].bones[bone].oxr;														// Add initial rotations
		y+=this.models[model].bones[bone].oyr;
		z+=this.models[model].bones[bone].ozr;
		this.models[model].bones[bone].rotation.x=x;												// Rotate 						
		this.models[model].bones[bone].rotation.y=y;													
		this.models[model].bones[bone].rotation.z=z;													
	}

// POSES ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	SetPose(model, id, time)																	// SET A POSE FOR A MODEL
	{
		var i;
		var v=app.poses[id];																		// Get pose string
		if (!v || !model)	return;																	// Quit if no string or model
		v=v.split(",");																				// Get bone positions
		for (i=0;i<v.length;i+=4)																	// Stride by 4
			this.SetBone(model,v[i],v[i+1]-0,v[i+2]-0,v[i+3]-0);									// Set bone
		var angle=(this.models[model].bones["thighL"].rotation.x-this.models[model].bones["thighL"].oxr)*180/Math.PI;	// Angle of left thigh in degress
		this.models[model].bones["base"].position.z=angle/40;										// Left thigh controls height for sitting									
		}

	PoseEditor()																				// POSE EDITOR
	{
		var _this=this;
		if ($("#poseEditor").length) {																// If already up, bring it down
			$("#poseEditor").hide("slide",{ direction:"down", complete: ()=>{ $("#poseEditor").remove(); } }); // Slide down
			return;																					// Quit																					
			}
		var str="<div id='poseEditor' class='lz-dialog' style='display:none;top:calc(100vh - 300px) '>";
		str+="<img src='img/lizalogo.png' style='vertical-align:-6px' width='64'><span style='font-size:18px;margin-left:8px'>pose editor</span>";	
		str+="<img src='img/closedot.gif' style='float:right' onclick='$(\"#poseEditor\").remove();'><br><br>";
		str+="<table>";
		str+="<tr><td>Student: </td><td>"+MakeSelect("beModel",false,[]);									// Model id
		str+="&nbsp;&nbsp;&nbsp;Pose:&nbsp;"+MakeSelect("bePose",false,[]);									// Pose
		str+="&nbsp;&nbsp;&nbsp;Bone:&nbsp;"+MakeSelect("beBone",false,[]);									// Bone
		str+="<div class='lz-bs' id='beZero' style='float:right;margin-right:12px'>0</div></td></tr>";		// Bone id/zero
		str+="<tr><td>&nbsp;</td></tr>";
		str+="<tr><td>X&nbsp;axis&nbsp;&nbsp;</td><td><input type='range' min=-180 max=180 value=0 style='width:470px' id='beXaxis'>"					// X slider
		str+="&nbsp;&nbsp;<input type='text' class='lz-is' id='beXval' value=0 style='width:30px;vertical-align:6px;text-align:center'></td></tr>";		// X slider value
		str+="<tr><td>Y&nbsp;axis&nbsp;&nbsp;</td><td><input type='range' min=-180 max=180 value=0 style='width:470px' id='beYaxis'>"					// Y
		str+="&nbsp;&nbsp;<input type='text' class='lz-is' id='beYval' value=0 style='width:30px;vertical-align:6px;text-align:center'></td></tr>";		// Y
		str+="<tr><td>Z&nbsp;axis&nbsp;&nbsp;</td><td><input type='range' min=-180 max=180 value=0 style='width:470px' id='beZaxis'>"					// Z
		str+="&nbsp;&nbsp;<input type='text' class='lz-is' id='beZval' value=0 style='width:30px;vertical-align:6px;text-align:center'></td></tr>";		// Z
	
		str+="</table><br>";																			
		str+="Sequence:&nbsp;"+MakeSelect("beSeqs",false,[]);																			
		str+="&nbsp;&nbsp;&nbsp;Fidget?&nbsp;<td><input type='checkbox' id='beFidget'"+(app.students[app.curStudent].fidget ? " checked" : "")+">" ;																			
		str+="<div class='lz-bs' id='beReset' style='float:right;margin-right:4px'>Reset</div>";																		
		str+="</div>";

		$("body").append(str);																		// Add to body
		$("#poseEditor").show("slide",{ direction:"down"});											// Bring up	
		addModels();																				// Load models for pulldown
		addBones();																					// Load bones for pulldown
		addPoses();																					// Load poses for pulldown
		addSeqs();																					// Load sequences for pulldown
		if (!isMobile)	$("#poseEditor").draggable();												// Make it draggable on desktop

		$("#poseEditor").on("mousedown touchdown", (e)=> { e.stopPropagation();  } );				// Don't move orbiter
		$("#poseEditor").on("touchmove", (e)=> { e.stopPropagation();  } );							// Don't move orbiter
		$("#beXaxis").on("input",  function(e) { $("#beXval").val(this.value); moveBone(); } );		// Show x value	
		$("#beXval").on("change",  function(e) { $("#beXaxis").val(this.value); moveBone(); } );	// Set x value manually	
		$("#beYaxis").on("input",  function(e) { $("#beYval").val(this.value); moveBone(); } );		// Y
		$("#beYval").on("change",  function(e) { $("#beYaxis").val(this.value); moveBone(); } );	// Y	
		$("#beZaxis").on("input",  function(e) { $("#beZval").val(this.value); moveBone(); } );		// Z
		$("#beZval").on("change",  function(e) { $("#beZaxis").val(this.value); moveBone(); } );	// Z
		$("#beFidget").on("click", function(e) { app.students[app.curStudent].fidget=$(this).prop("checked") ? 1 : 0 });		// Toggle fidget flag
	
		$("#beModel").on("change", function(e) { 													// Change model
			for (var i=0;i<app.students.length;++i) 
				if ($(this).val() == app.students[i].id)	app.curStudent=i;						// Make it current student	
			});
		
		$("#bePose").on("change", function(e) { 													// Add new pose
			app.sc.SetPose($("#beModel").val(),this.value);											// Show new pose							
			$("#beXval").val(0);	$("#beYval").val(0);	$("#beZval").val(0);					// Set indicator
			$("#beXaxis").val(0);	$("#beYaxis").val(0);	$("#beZaxis").val(0);					// Set slider
			$("#bePose").prop("selectedIndex",0);													// Reset pulldown
			$("#beBone").trigger("change"); 														// Force bone to update
			});
			
		$("#beBone").on("change",  function(e) {
			var v;
			var model=$("#beModel").val();															// Model id
			var bone=$("#beBone").val();															// Bone id
			if (bone == "Choose bone")	return;														// Quit on no bone
			v=(Math.round((_this.models[model].bones[bone].rotation.x-_this.models[model].bones[bone].oxr)*180/Math.PI)*100)/100;	// Get X degrees
			$("#beXval").val(v);	$("#beXaxis").val(v);											// Set slider
			v=(Math.round((_this.models[model].bones[bone].rotation.y-_this.models[model].bones[bone].oyr)*180/Math.PI)*100)/100;	// Get Y degrees
			$("#beYval").val(v);	$("#beYaxis").val(v);											// Set slider
			v=(Math.round((_this.models[model].bones[bone].rotation.z-_this.models[model].bones[bone].ozr)*180/Math.PI)*100)/100;	// Get Z degrees
			$("#beZval").val(v);	$("#beZaxis").val(v);											// Set slider
			});

		$("#beZero").on("click", ()=>  {															// ZERO BONE TO ORIGINAL STATE	
			$("#beXval").val(0);	$("#beYval").val(0);	$("#beZval").val(0);					// Set indicator
			$("#beXaxis").val(0);	$("#beYaxis").val(0);	$("#beZaxis").val(0);					// Set slider
			this.SetBone($("#beModel").val(),$("#beBone").val(),0,0,0);								// Set bone						
			});

		$("#beSeqs").on("change", ()=>  {															// RUN SEQUENCE
			this.StartAnimation($("#beModel").val(),app.seqs[$("#beSeqs").val()]);					// Start animating
			if ($("#beSeqs").val() == "talk")	app.voice.Talk("My name is Liza. How are you today? Would you like to play a game?");
			$("#beSeqs").prop("selectedIndex",0);		$("#beBone").prop("selectedIndex",0);		// Reset pulldowns
			});
		
		$("#beReset").on("click", ()=>  {															// REST ALL BONES TO ORIGINAL STATE	
			$("#beXval").val(0);	$("#beYval").val(0);	$("#beZval").val(0);					// Set indicator
			$("#beXaxis").val(0);	$("#beYaxis").val(0);	$("#beZaxis").val(0);					// Set slider
			var base=this.models[$("#beModel").val()].bones;										// Point at bones array
			for (var bone in base) 	this.SetBone($("#beModel").val(),bone,0,0,0);					// Set bone						
			});

		function addModels() {																		// FILL MODELS PULLDOWN
			var i, v=[];
			$("#beModel").empty();																	// Clear select
			$("#beModel").append("<option>Choose student</option>");								// Add choose
			for (i=0;i<app.students.length;++i)	v.push(app.students[i].id);							// Get all students
			v.sort();																				// Sort 
			for (i=0;i<v.length;++i) 	$("#beModel").append("<option>"+v[i]+"</option>");			// Add option
			$("#beModel").val(app.students[app.curStudent].id);										// Current student
		}

		function addBones() {																		// FILL BONES PULLDOWN
			var v=[];
			$("#beBone").empty();																	// Clear select
			$("#beBone").append("<option>Choose bone</option>");									// Add choose
			var base=_this.models[$("#beModel").val()].bones;										// Point at bones array
			for (var bone in base) 			v.push(bone);											// Add bone to array
			v.sort();																				// Sort bones
			for (var i=0;i<v.length;++i) 	$("#beBone").append("<option>"+v[i]+"</option>");		// Add option
			}

		function addPoses() {																		// FILL POSES PULLDOWN
			var v=[];
			$("#bePose").empty();																	// Clear select
			$("#bePose").append("<option>Choose pose</option>");									// Add choose
			var base=app.poses;																		// Point at poses array
			for (var p in app.poses) 			v.push(p);											// Add pose to array
			v.sort();																				// Sort bones
			for (var i=0;i<v.length;++i) 	$("#bePose").append("<option>"+v[i]+"</option>");		// Add option
			}

		function addSeqs() {																		// FILL SEQS PULLDOWN
			var v=[];
			$("#beSeqs").empty();																	// Clear select
			$("#beSeqs").append("<option>Choose sequence</option>");								// Add choose
			for (var p in app.seqs) 			v.push(p);											// Add sequence to array
			v.sort();																				// Sort bones
			for (var i=0;i<v.length;++i) 	$("#beSeqs").append("<option>"+v[i]+"</option>");		// Add option
			$("#beSeqs").append("<option>talk</option>");											// Add talk
			}

		function moveBone() {																		// Move the bone
			var x=$("#beXaxis").val(),y=$("#beYaxis").val(),z=$("#beZaxis").val();					// Get vals
			if ($("#beBone").val() == "base")	x=x*3,z=z*3;										// Scale up base x & z
			_this.SetBone($("#beModel").val(),$("#beBone").val(),x,y,z);							// Set bone
			}
	}
	
// ANIMATION ///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	Render() 																					// RENDER LOOP
	{
		app.sc.controls.update();																	// Update control time
		requestAnimationFrame(app.sc.Render);														// Set timer
		app.sc.AnimateScene();																		// Animate models
		if (app.sc.outliner) 	app.sc.outliner.render(app.sc.scene, app.sc.camera );				// Render outline
		else					app.sc.renderer.render(app.sc.scene,app.sc.camera);					// Render scene
		}

	AnimateScene()																				// CALLED EVERY FRAME BY ANIMATE FUNCTION
	{
		var i,j,pct,a;
		var seq,bones,model,br,b;
		var x,y,z;
		var now=new Date().getTime();																// Get current time in ms
		for (i=0;i<app.animateData.length;++i)	{													// For each action
			seq=app.animateData[i];																	// Point at action
			if (now < seq.start) continue;															// Ignore if before action
			if (now > seq.start+seq.dur) {															// If past action
				app.animateData.splice(i,1);														// Remove it
				continue;																			// Ignore 
				}
			pct=(now-seq.start)/seq.dur;															// Get % in sequence
			pct=1.0-((Math.cos(3.1414*pct)+1)/2.0);													// Full cosine curve
			for (j=0;j<seq.bones.length;++j) {														// For each bone
				b=seq.bones[j];																		// Point at bone 						
				br=app.sc.models[seq.model].bones[b.bone].rotation;									// Point at rotation						
				if (b.bone == "base") {																// Base bone's X & Z axes set by object directly, not bone
					br.x=app.sc.models[seq.model].bones[b.bone].oxr;								// Don't move XR
					br.z=app.sc.models[seq.model].bones[b.bone].ozr;								// ZR
					br.y=b.sy+(b.ey-b.sy)*pct;														// Y
					model=this.models[seq.model].model;												// Point at model			
					model.position.x=b.sx+(b.ex-b.sx)*pct+model.oxp;								// Set base X position via model, not bone
					model.position.z=b.sz+(b.ez-b.sz)*pct+model.ozp;								// Z
					}	
				else{																				// Normal bone
					br.x=b.sx+(b.ex-b.sx)*pct;														// Interpolate x angle and set bone to it
					br.y=b.sy+(b.ey-b.sy)*pct;														// Y
					br.z=b.sz+(b.ez-b.sz)*pct;														// Z
					}
				}															
			a=(this.models[seq.model].bones["thighL"].rotation.x-this.models[seq.model].bones["thighL"].oxr)*180/Math.PI;	// Angle of left thigh in degress
			this.models[seq.model].bones["base"].position.z=a/40;									// Left thigh controls height for sitting									
			}
		
		var jaw=[0,0,0,1,2,3,4,3,2,4,4,3,2,1,1,1,1,2,3,4,3,3,2,2,1,1,0,0,0,0]
		if (app.voice.talking == 1)																	// If student talking
			app.sc.SetBone(app.students[app.curStudent].id,"mouth",jaw[app.sc.aniTimer%(jaw.length-1)]*2,0,0);		// Animate mouth
		for (i=0;i<app.students.length;++i)															// For each student
			if (app.students[i].fidget)	{															// If fidgeting
				app.sc.SetBone(app.students[i].id,"thighR",-78,Math.cos(app.sc.aniTimer/15*Math.PI)*1+1*.0001,0);		// LegR
				app.sc.SetBone(app.students[i].id,"thighL",-78,-Math.cos((app.sc.aniTimer+10)/15*Math.PI)*1+1*.0001,0);	// LegL
				app.sc.SetBone(app.students[i].id,"thumbR",Math.cos(app.sc.aniTimer/30*Math.PI)*20,0,0);				// ThumbR
				app.sc.SetBone(app.students[i].id,"thumbL",Math.cos((app.sc.aniTimer+20)/30*Math.PI)*20,0,0);			// ThumbL
				app.sc.SetBone(app.students[i].id,"neck",0,0,Math.cos(app.sc.aniTimer/15*Math.PI)*2+2*.0001);			// Neck
				}	
		++app.sc.aniTimer;																			// Advance timer
	}

	StartAnimation(model, seqs)																	// QUEUE UP ACTION SEQUENCE
	{
		var i,j,k,b,o,v;
		var cbs=[],rad,bs;
		if (!seqs)	return;																			// Quit of no seqs
		seqs=seqs.split(",");																		// Get parts
		var repeat=seqs[seqs.length-1];																// Last element is repeat
		if (!seqs.length%2)	repeat=1;																// If omitted, do it one time
		var modObj=this.models[model].model;														// Point at model object
		var bones=this.models[model].bones;															// Point at bones array of model
		for (b in bones)	cbs[b]={ x:bones[b].rotation.x, y:bones[b].rotation.y, z:bones[b].rotation.z }; // Save rotation for each bone			
		cbs["base"].x=modObj.position.x-modObj.oxp;													// Get X position from model for base bone
		cbs["base"].z=modObj.position.z-modObj.ozp;													// Z
		var start=new Date().getTime();																// Start time for sequence member

		for (i=0;i<repeat;++i) {																	// For each time to do it
			for (j=0;j<seqs.length-1;j+=2) {														// For each sequence member bone/time pair
				if (!app.poses[seqs[j]])	continue;												// Bad pose
				v=app.poses[seqs[j]].split(",");													// Point at bones parts
				bs=[];																				// Clear bone array
				for (k=0;k<v.length;k+=4) {															// Stride by 4
					o={ bone:v[k] };																// Add bone name
					rad=(v[k] == "base") ? 1 : Math.PI/180;											// Convert to radians on all bones except base
					b=bones[v[k]];																	// Point at bone
					o.sx=cbs[v[k]].x;	 o.sy=cbs[v[k]].y;  		o.sz=cbs[v[k]].z;				// Start from current pos
					cbs[v[k]].x=o.ex=v[k+1]*rad+b.oxr;												// Normalized end X pose, and set new cbs
					cbs[v[k]].y=o.ey=v[k+2]*rad+b.oyr;  											// Y
					cbs[v[k]].z=o.ez=v[k+3]*rad+b.ozr;												// Z
					bs.push(o);
					}
				app.animateData.push({ model:model, start:start, dur:seqs[j+1]*1000, bones:bs });	// Save animation data
				start+=seqs[j+1]*1000;																// Start next member at end of last
				}
			}
	}


}  // SCENE CLOSURE

















//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

$(window).resize(function() {                                         	// ON WINDOW RESIZE
	app.sc.Resize();														// Resize 3D
	if (app && app.allowResize)												// If app loaded and allowing resizing
		app.Draw();															// Redraw to fit screen
	});
			
$(document).ready(function() {								           	// ON PAGE LOADED
	isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false; // Set mobile flag
	var url=window.location.search.substring(1);						   	// Get query string
	app=new App(url);                                                      	// Alloc app
	if ((window.location.host != "localhost") && (url != "preview")) {		// Not in debug or preview
		$("#splashDiv").fadeIn();											// Fade in splash page
		$("#startBut").click( ()=> {										// On start button clicked
			$("#splashDiv").fadeOut();										// Fade out splash
			$("#mainDiv").fadeIn(2000);										// Fade in main
			$("#controllerDiv").fadeIn(2000);								// Fade in controller
			})
		}
	else{																	// Debug
		$("#mainDiv").fadeIn(0);											// Load fast
		$("#controllerDiv").fadeIn(0);										// Controller too
			}

	if (window.addEventListener) 											// If supported this way
		window.addEventListener("message",html5MessageHandler,false);		// Add event handler
	else																	// Use other method
		window.attachEvent("message",html5MessageHandler);					// Add handler
	
	$(window).on("keydown",function(e) {									// HANDLE KEYPRESS
		if ((e.which == 84) && e.altKey && e.ctrlKey)						// Test key (Ctrl+Alt+T)
			app.Playback();													// Playback actions

		if ((e.which == 65) && e.altKey && e.ctrlKey)						// Test key (Ctrl+Alt+A)
			app.voice.Talk("");												// Enable audio

		});
 
 });	
 

	function html5MessageHandler(e)										// ON HTML5 MESSAGE
	{
	//	if (e && e.data) 													// If a valid message				
	//		trace(e);														// Route
	}

////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function DialogBox(title, content, width, callback, callback2) 			// DIALOG BOX
	{
		$("#dialogDiv").remove();												
		$("body").append("<div class='unselectable' id='dialogDiv'></div>");														
		var str="<p><img src='img/logo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span id='gtBoxTi'style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>"+title+"</b></span><p>";
		str+="<div style='font-size:14px;margin:14px'>"+content+"</div>";
		$("#dialogDiv").append(str);	
		$("#dialogDiv").dialog({ width:Math.abs(width), buttons: {
					            	"OK": 		function() { if (callback)
					            								callback(); 
					            								$(this).remove();  
					            								},
					            	"Cancel":  	function() { if (callback2)	            		
					            								callback2();
					            								$(this).remove(); }
									}});	
		if (width < 0)
			$("#dialogDiv").dialog("option","position",{ my:"left top", at:"left top", of:this.parent });
		else
			$("#dialogDiv").dialog("option","position",{ my:"center", at:"center", of:this.parent });
	}

	function GetTextBox(title, content, def, callback)					// GET TEXT LINE BOX
	{
		$("#alertBoxDiv").remove();											// Remove any old ones
		$("body").append("<div id='alertBoxDiv'></div>");														
		var str="<p><img src='img/scalelogo.png' width='32' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span id='gtBoxTi'style='font-size:18px'><b>"+title+"</b></span><p>";
		str+="<div style='font-size:12px;margin:14px'>"+content;
		str+="<p><input class='lz-is' style='width:75%' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='lz-bs'>OK</div>";
		str+="<div id='dialogCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ width:400 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center" });
		$("#alertBoxDiv").css({ border:"1px solid #999","border-radius":"6px"});

		$("#dialogOK").on("click", function() {							// ON OK BUT
					callback($("#gtBoxTt").val());
					$("#alertBoxDiv").remove();  
				});

		$("#dialogCancel").on("click", function() {						// ON CANCEL BUT
				$("#alertBoxDiv").remove();								// Remove 
				});

		}

	function ConfirmBox(title, content, callback, callback2)							// CONFIRMATION BOX
	{
		Sound("ding");																		// Ding sound
		$("#confirmBoxDiv").remove();														// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv'></div>");														
		var str="<img src='img/scalelogo.png' width='32' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:18px; color:#666'><b>"+title+"</b></span><br>";
		str+="<p>"+content+"<p>";
		str+="<div style='float:right'><div id='confirmOK' class='lz-bs'>OK</div>";
		str+="<div id='confirmCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);	
	
		$("#confirmOK").on("click", function() {											// ON OK BUT
				$("#confirmBoxDiv").remove();												// Remove 
				if (callback)	callback();													// If callback defined, run it
				});

		$("#confirmCancel").on("click", function() {										// ON CANCEL BUT
				$("#confirmBoxDiv").remove();												// Remove 
				if (callback2)	callback();													// If callback defined, run it
				Sound("delete");															// Delete sound
				});
	}

	function PopUp(msg, time, div)											// TIMED POPUP
	{
		var str="";
		$("#popupDiv").remove();												// Kill old one, if any
		str+="<div id='popupDiv' class='lz-popup'>"; 							// Add div
		if (time == -1) {														// If has close but
			time=100000;														// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";	// Add close button
			}
		str+=msg+"</div>"; 														// Add div
		$(div ? "#"+div : "body").append(str);									// Add popup to div or body
		$("#pu-close").click(function() { $("#popupDiv").remove(); });			// Remove on click of close but
		$("#popupDiv").fadeIn(500).delay(time ? time : 3000).fadeOut(500)		// Animate in and out		
	}

	function Prompt(msg, time)												// TIMED PROMPT
	{
		var str="";
		$("#promptSpan").html(msg);												// Add message
		$("#promptSpan").fadeIn(500).delay(time ? time : 3000).fadeOut(500)		// Animate in and out		
	}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function trace2(msg, p1, p2)											// VISIBLE CONSOLE (FOR IOS)
	{
		msg+=(p1 != undefined) ? (","+p1) : ""; 								// Add with comma
		msg+=(p2 != undefined) ? (","+p2) : ""; 
		if (!$("#errorDiv")[0])													// If not initted
			$("body").append("<div id='errorDiv' class='lz-error'></div>");		// Add div
		$("#errorDiv").append(msg+"<br> ");										// Print msg
		console.log(msg);														// On console too
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)					// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");		// Use built in mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}
		
	function ShortenString(str, len)										// SHORTEN A STRING TO LENGTH
	{
		if (str && str.length > len)											// Too long
			str=str.substr(0,(len-3)/2)+"..."+str.slice((len-3)/-2);			// Shorten	
		return str;																// Return string
	}

	function MakeSelect(id, multi, items, sel, extra, values)				// CREATE HTML SELECT
	{
		var	str="<select class='lz-is' style='width:auto' id='"+id+"'";			// Header
		str+=" data-lastselect='"+(sel ? sel : '')+"' ";						// Init last selected
		if (multi)																// Multi select
			str+="multiple='multiple' size='"+multi+"'";						// Add flag
		if (extra)																// If extra param
			str+=extra;															// Add them
		str+=">";																// End header
		for (i=0;i<items.length;++i) {											// For each option
			str+="<option";														// Add tag
			if (values && values[i]) {											// If has a value
				str+=" value='"+values[i]+"'";									// Add it
				if (sel == values[i])	str+=" selected='selected'"				// If value selected, add tag
				}
			else if (sel == items[i])	str+=" selected='selected'"				// If name selected, add tag
			str+=">"+items[i]+"</option>";										// End option
			}	
		return str+"</select>";													// End select				
	}
	

</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-133670235-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-133670235-1');
</script>

</body>
</html>
