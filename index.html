<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>Classroom</title>
	<meta name="viewport" content="width=device-width", initial-scale=1.0, user-scalable=no>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<link rel="preload" href="img/Inkfree.ttf" as="font" type="font/ttf" crossorigin>
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>	
	<script src="lib/wgl/three.min.js"></script>
	<script src="lib/wgl/ColladaLoader.js"></script>
	<script src="lib/wgl/OrbitControls.js"></script>
	<script src="lib/wgl/OutlineEffect.js"></script>
	<script src="scene.js"></script>
	<script src="blackboard.js"></script>
	<script src="voice.js"></script>
	
	<style>
		 body { 			font-family:Verdana,Geneva,sans-serif;font-size:13px; box-sizing:border-box; 
							padding:0;margin:0; position: fixed; width:100%;
							}
		.lz-splash { 		color:#999; text-align:center; margin-top:5%;  display:none;
							}
		.lz-about { 		position: relative; width:100%; max-width:800px; height:calc(100vh - 28px); margin: 12px auto; border:none; 
							}
		.lz-main { 			width:100%; height:100%; background-color: #ddd; display:none; text-align:center;
							}
		.lz-error { 		position: absolute; top:16px; left:19px;
							}
		.lz-controller {	position: fixed; top: calc(100% - 39px); left:0; background-color: #aaa; border: 1px solid #999;
							padding:6px 12px; width: calc(100% - 24px); height:25px;  display:none;
							}
		.lz-dialog {		position: absolute; top:16px; left:16px; background-color: #eee; border: 1px solid #aaa;
							padding:16px; border-radius: 16px; width: 600px;
							}
		.lz-blackboard {	position: absolute; left:16px; top: calc(100vh - 336px); width: 550px; height: 256px;  display:none;
							background-color: #999; border: 1px solid #999;	padding:12px; border-radius: 8px; 
							}
		.lz-textS {			background-color:#eeeeee; border-radius:8px; padding:8px; width:fit-content; max-width: 66%; 
							margin-bottom:8px; cursor:pointer;
							}
		.lz-textR {			background-color:#a7e5fd; border-radius:8px; padding:8px; width:fit-content; max-width: 66%; float:right
							}
		.lz-canvas {		position: absolute; left:50px; top: 12px; width: 512px; height:256px; border-radius: 4px;
							}
		.lz-confirm {		position: absolute;  width: 300px; padding: 16px; left: calc(50% - 150px); top: calc(50% - 50px); user-select: none;	
							border-radius: 8px; background-color: #fff; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							}
		.lz-popup {			position: absolute;  width: auto; padding: 12px; left: calc(50% - 100px); top: calc(50% - 50px);
							border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							font-size: 14px; text-align:center; display: none;
							}
		.lz-prompt {		color:#fff; width:100%;	vertical-align: 3px; margin-left:16px; font-size:16px;
							}
		.lz-is {			border-radius:16px; padding:0 8px; width:200px; height: 24px;
							border:1px solid #999; font-size: 13px;
							}
		.lz-bs {			cursor: pointer; color:#fff; 
							text-align: center; border-radius: 16px; display: inline-block; user-select: none;
							font-size: 12px; background-color: #27ae60; padding: 2px 8px 2px 8px; vertical-align:3px;
							}

		 table {			border-spacing: 0px;  }

		 @font-face {  		font-family: Chalk; src: url(img/Inkfree.ttf);   }

</style>
</head>
<body>
	
	<div id="mainDiv" class="lz-main"></div>
	<div id="splashDiv" class="lz-splash">
		<img src="img/lizalogo.png" style='width:25%;opacity:.66;' alt=""><br>
		<br><p style="color:#000;font-size:14px"><em>A tool for engaging people in highly affective script-driven discourse<br>for learning and practicing goal-directed behaviors.</em></p>
		<br><div id='startBut' class='lz-bs' onclick='app.voice.Talk("hello")'>Start</div><br><br>
		<div style='color:#000'><br>
			<b>This demo ONLY runs in the Chrome Desktop Browser</b><br><br>
			Right now it reacts to only few things like:<br><br>
			• Does anyone know what 2 + 2 equals?<br>
			• Robert, what is 3+3?<br>
			• How did you come up with that answer?<br>
			• Does anyone know what time it is?<br>
			• Everyone go to sleep<br>
			• Sara, wakeup<br><br>
			If you refer to the class, some students will raise their hands and you need to choose one.<br> 
			If you refer to a student by name, they will answer directly.<br> 
			You need to tap the green microphone button (or tap the spacebar) to start speaking.<br>
			There is more information in the help (?) button at the bottom of the screen.
		</div>
	</div>
	<div id="controllerDiv" class="lz-controller">
		<span id="talkSpan">
			<img id="talkBut" src="img/talkbut.png" title="Click to talk" style="cursor:pointer">
		</span>
		<img id="writeBut" src="img/editbut.gif" title="Draw on blackboard" style="cursor:pointer;margin-left:24px">
		<span id='promptSpan' class='lz-prompt'></span>

		<img id="helpBut" src="img/helpicon.gif" title="Help" style="cursor:pointer;margin-right:4px;float:right">
		<img id="reviewBut" src="img/scriptbut.gif" title="Lesson plan" style="cursor:pointer;margin-right:16px;float:right">
		<img id="settingsBut" src="img/settingsbut.gif" title="Settings" style="cursor:pointer;margin-right:16px;float:right">
		<div style="color:#eee;font-size:12px;float:right; margin: 4px 16px">The University of Virginia @ 2019</div>
	</div>
	<div id='blackboardDiv' class='lz-blackboard'>
		<br><img id="BB-DrawBut" src="img/line-icon.png" style="cursor:pointer;margin-bottom:12px;margin-top:-12px" title="Draw"><br>
		<img id="BB-EraseBut" src="img/eraser-icon.png" style="cursor:pointer;margin-bottom:12px" title="Erase"><br>
		<img id="BB-TextBut" src="img/text-icon.png" style="cursor:pointer;margin-bottom:12px" title="Text"><br>
		<img id="BB-ImageBut" src="img/image-icon.png" style="cursor:pointer;margin-bottom:60px" title="Pics"><br>
		<img id="BBClearBut" src="img/trash-icon.png" style="cursor:pointer;margin-bottom:4px" title="Clear all">
		<div id="BBSideBut" style="cursor:pointer;color:#fff;font-size:11px;margin-left:-5px" title="Side">&nbsp;LEFT</div>
		<canvas id="blackboardCan-0" height=256 width=512 class='lz-canvas' tabindex='1'></canvas>
		<canvas id="blackboardCan-1" height=256 width=512 class='lz-canvas' tabindex='1'></canvas>
		</div>
<script>

/////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

var app=null;																						// Holds app
var isMobile=false;																					// Flag for mobile devices

	$(window).resize(function() {                                         						// ON WINDOW RESIZE
		app.sc.Resize();																			// Resize 3D system
		if (app && app.allowResize)																	// If app loaded and allowing resizing
			app.Draw();																				// Redraw to fit screen
		});
				
	$(document).ready(function() {								           						// ON PAGE LOADED
		isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false;			// Set mobile flag
		var url=window.location.search.substring(1);						   						// Get query string
		app=new App(url);                                                    						// Alloc app
		if (window.location.host != "localhost") {													// Not in debug
			$("#splashDiv").fadeIn();																// Fade in splash page
			$("#startBut").click( ()=> {															// On start button clicked
				$("#splashDiv").fadeOut();															// Fade out splash
				$("#mainDiv").fadeIn(2000);															// Fade in main
				$("#controllerDiv").fadeIn(2000);													// Fade in controller
				})
			}
		else{																						// Debug
			$("#mainDiv").fadeIn(0);																// Load fast
			$("#controllerDiv").fadeIn(0);															// Controller too
			}

		if (window.addEventListener) 																// If supported this way
			window.addEventListener("message",html5MessageHandler,false);							// Add event handler
		else																						// Use other method
			window.attachEvent("message",html5MessageHandler);										// Add handler
		
		$(window).on("keydown",function(e) {														// HANDLE KEYPRESS
			if ((e.which == 84) && e.altKey && e.ctrlKey)	{										// Test key (Ctrl+Alt+T)
				app.rec.Reviewer();	

				/*				var ability=.5;
				var count=0;

				var r=Math.random();																// Get random number
				if (r/ability < .2)		so=[[1,0,0]];												// If really low, force a none response
				else {																				// Calc starting matrix
					r=Math.max(Math.min(ability+((r-.5)*(1+ability)),1),0); 						// Calc chance of right answer capped 0-1
					so=[[0,r,1-r]];																	// Set starting matrix
					}
//                             N                 R                W									// Heading
				var tm=[ [0.0, .40, .60], [0.0, .55, .45], [0.0, .46, .54] ];						// Markov transition matrix
		
				TraceMatrix(so);
				for (i=0;i<4;++i) {
					so=MatrixMultiply(so,tm)
					TraceMatrix(so);
					} 
				*/
			}
			if ((e.which == 65) && e.altKey && e.ctrlKey)											// Test key (Ctrl+Alt+A)
				app.voice.Talk("");																	// Enable audio
			else if ((e.which == 71) && e.altKey) {													// Show spreadsheet (Alt+G)
				window.open("https://docs.google.com/spreadsheets/d/"+app.gid,"_blank");			// Show it	
				}
			});
	});	
 

	function html5MessageHandler(e)																// ON HTML5 MESSAGE
	{
	//	if (e && e.data) 																			// If a valid message				
	//		trace(e);																				// Route
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																					

	constructor(id)   																			// CONSTRUCTOR
	{
		app=this;
		this.poses=[];																				// Holds poses
		this.seqs=[];																				// Holds pose sequences
		this.desks=[];																				// Holds desks	
		this.animateData=[];																		// Holds animation data
		this.students=[];																			// Holds students	
		this.startTime=new Date().getTime();														// Session start time
		this.pickingStudent="";																		// Flag for picking student
		this.curGoal="";																			// Current goal in focus
		this.curStudent=0;																			// Currently active student

		this.gid="1ez3sEcWaNk9QgoRRGn5BOQYj541wBcrx8Es2ClJMmbU";									// Default ARC tree spreadshet
		var url=window.location.search.substring(1);						   						// Get query string
		if (url) {																					// If params
			if (url.match(/gid=/i)) 	this.gid=url.split("&")[0].substr(4);						// If params have a 'gid=' tag, use it
			else						this.gid=url;												// Just plain
			}
		this.bb=new Blackboard();																	// Make blackboard		
		this.arc=new ARC();																			// Make new ARC tree		
		this.sc=new Scene("mainDiv");																// Make new scene		
		this.voice=new Voice(this.OnPhrase);														// Alloc TTS/STT
		this.rec=new Record();																		// Make new recorder		
		this.rev=new Review();																		// Make new reviewer		
		this.LoadProject(this.gid);																	// Load project file
		this.LoadModels();																			// Load 3D models
		this.Draw();																				// Start 

		if (!this.voice.hasRecognition) 															// This platform doesn't have voice recognition
			$("#talkSpan").html("<input id='talkInput' type='text' class='lz-is' style='vertical-align:4px' placeholder='Talk by typing here'>");	// Put in text input field
		$("#settingsBut").on("click", ()=> { app.sc.PoseEditor();  });								// On settings button click	
		$("#reviewBut").on("click", ()=> { app.rev.Reviewer();  });									// On review button click	
		$("#talkBut").on("click", ()=> { app.voice.Listen(); });									// On talk button click, start listening
		$("#helpBut").on("click", ()=> { app.ShowHelp(); });										// On help button click, show help
		$("#writeBut").on("click", ()=> { 															// On BB button clck
			var m=$("#blackboardDiv").css("display") == "none" ? 1 : 0;								// Hide or show
			$("#blackboardDiv").toggle("slide",{ direction:"down"}) 								// Slide
			app.rec.Add({ o:'B', m:m }); 													// Add to record
			}); 
		$("#talkInput").on("click",  function() { $(this).focus() });								// On click, set focus
		$("#talkInput").on("change", function() { app.OnPhrase( $(this).val()), $(this).val("") });	// On enter, act on text typed
		$("body").on("keydown", (e)=> {																// On key hit
			if ((e.target == document.body) && (e.keyCode == 32) && this.voice.hasRecognition)		// Spacebar in body
				 app.voice.Listen();																// Start listening	
			});															
	}

	LoadProject(id)																				// LOAD PROJECT DATA
	{
		this.arc.Load(id);																			// Load from Google doc
		var tex=this.sc.cartoonScene ? 0xffffff : "lib/wgl/map.jpg";								// Desks cartoon or real				
		this.desks.push({ id:"desk1", src:"assets/desk.dae", x:-120, y:-100, z:0, s:20, r:0, tex:tex} );	
		this.desks.push({ id:"desk2", src:"assets/desk.dae", x:0, y:-100, z:0, s:20, r:0, tex:tex} );		
		this.desks.push({ id:"desk3", src:"assets/desk.dae", x:120, y:-100, z:0, s:20, r:30, tex:tex} );		
		this.desks.push({ id:"desk4", src:"assets/desk.dae", x:-120, y:100, z:0, s:20, r:-10, tex:tex} );		
		this.desks.push({ id:"desk5", src:"assets/desk.dae", x:0, y:100, z:0, s:20, r:0, tex:tex} );		
		this.desks.push({ id:"desk6", src:"assets/desk.dae", x:120, y:100, z:0, s:20, r:0, tex:tex} );		
		if (!window.location.search.match(/one/i)) {
			this.students.push({ id:"Freddy", src:"assets/body.dae", x:-120, y:-112, z:0, s:15, r:0, tex:this.sc.cartoonScene ? "assets/freddyskin.png" : "assets/skin1.png", sex: "male", fidget:0, ability:.2} );
//			this.students.push({ id:"Joe", src:"assets/body.dae", x:0, y:-112, z:0, s:15, r:0, tex:this.sc.cartoonScene ? "assets/joeskin.png" : "assets/skin1.png", sex: "male", fidget:0, ability:.5 } );
//			this.students.push({ id:"Sally", src:"assets/body.dae", x:120, y:-112, z:1, s:15, r:0, tex:this.sc.cartoonScene ? "assets/sallyskin.png" : "assets/skin1.png", sex: "female", fidget:0, ability:.5 } );
			this.students.push({ id:"Sara", src:"assets/body.dae", x:-120, y:88, z:0, s:15, r:-10, tex:this.sc.cartoonScene ? "assets/saraskin.png" : "assets/skin1.png", sex: "female", fidget:0, ability:.8 } );
			this.students.push({ id:"Robert", src:"assets/body.dae", x:0, y:88, z:0, s:15, r:0, tex:this.sc.cartoonScene ? "assets/robertskin.png" : "assets/skin1.png", sex: "male", fidget:0, ability:.5 } );
			}
		this.students.push({ id:"Liza", src:"assets/body.dae", x:120, y:88, z:1, s:15, r:0, tex:this.sc.cartoonScene ? "assets/lizaskin.png" : "assets/skin1.png", sex: "female", fidget:0, ability:.8 } );
	
		this.poses["startUp"]="armL,-51,4,-44,armR,-51,-4,44,base,0,0,0,chest,0,0,0,fingersL,0,0,0,fingersR,0,0,0,forearmL,0,0,-45,forearmR,0,0,47,legL,82,0,0,legR,83,0,0,mouth,0,0,0,neck,0,0,0,shoulderL,0,0,0,shoulderR,0,0,0,spine,0,0,0,thighL,-78,-8,0,thighR,-78,10,0,thumbL,0,0,0,thumbR,0,0,0,wristL,0,-50,0,wristR,8,0,0";
		this.poses["mouthOpen"]="mouth,8,0,0";			this.poses["mouthClosed"]="mouth,0,0,0";
		this.poses["headUp"]="neck,0,0,0";				this.poses["headDown"]="neck,16,0,0";	this.poses["headBack"]="neck,-16,0,0";
		this.poses["headLeft"]="neck,0,20,0";			this.poses["headRight"]="neck,0,-20,0"; this.poses["headCenter"]="neck,0,0,0";
		this.poses["leftLegStretch"]="legL,50,0,0";		this.poses["leftLegSit"]="legL,90,0,0";	
		this.poses["rightLegStretch"]="legR,50,0,0";	this.poses["rightLegSit"]="legR,90,0,0";	
		this.poses["leftArmDesk"]="armL,-60,0,-45,forearmL,0,0,-46";			this.poses["rightArmDesk"]="armR,-60,0,45,forearmR,0,0,46";
		this.poses["handUp"]="armL,25,0,0,forearmL,68,-25,0,wristL,0,-40,0";	this.poses["handDown"]="armL,-51,0,-44,forearmL,0,0,-45,wristL,0,0,0";	
		this.poses["handRight"]="forearmL,50,-25,0";	
		this.poses["twistLeft"]="neck,0,30,0,spine,0,33,0";						this.poses["twistRight"]="neck,0,-30,0,spine,0,-60,0";			
		this.poses["sleep"]="neck,45,62,0,chest,49,0,0,armL,-12,53,0,wristL,0,0,0,forearmL,120,-58,9,armR,0,30,0,forearmR,-90,0,0,wristR,0,0,0";
		this.poses["standUp"]="armL,-80,0,0,armR,-80,0,0,legL,0,0,0,legR,0,0,0,thighL,0,0,0,thighR,0,0,0,forearmL,0,0,0,forearmR,0,0,0,chest,0,0,0,base,50,0,0";
			
		this.seqs["sleep"]="sleep,1";
		this.seqs["standUp"]="standUp,1";
		this.seqs["sit"]="startUp,1";
		this.seqs["wave"]="handUp,.6,handRight,.5,4";
		this.seqs["nodYes"]="headBack,.4,headDown,.3,headUp,.3,1";
		this.seqs["nodNo"]="headLeft,.3,headRight,.3,headCenter,.3,2";
		this.seqs["headUp"]="headUp,1";			this.seqs["headDown"]="headDown,1";			
		this.seqs["headLeft"]="headLeft,1";		this.seqs["headRight"]="headRight,1";	this.seqs["headCenter"]="headCenter,1";
		this.seqs["armUp"]="handUp,1";			this.seqs["armDown"]="leftArmDesk,1";
		this.seqs["twistLeft"]="twistLeft,1";	this.seqs["twistRight"]="twistRight,1";
		this.curStudent=this.students.length-1;
	}

	LoadModels() 																				// LOAD 3D MODELS
	{
		var i;
		for (i=0;i<this.desks.length;++i)  		this.sc.AddModel(this.desks[i]);					// Load each desk		
		for (i=0;i<this.students.length;++i) {													 	// For each student	
			this.sc.AddModel(this.students[i]);														// Load model
			this.students[i].rMatrix=[];															// Holds response stage matrix
			}					
	}

	Draw() 																						// REDRAW
	{
		this.sc.Render();																			// Render scene and animate
	}

	ShowHelp() 																					// SHOW HELP
	{
		if ($("#helpDiv").length) {																// If already up, bring it down
			$("#helpDiv").hide("slide",{ direction:"down", complete: ()=>{ $("#helpDiv").remove(); } }); // Slide down
			return;																				// Quit																					
			}
		var h=window.innerHeight;
		var str="<div id='helpDiv' class='lz-dialog'style='height:"+(h-106)+"px;overflow:hidden;display:none;;left:calc(100vw - 646px)'>";
		str+="<img src='img/lizalogo.png' style='vertical-align:-6px' width='64'><span style='font-size:18px;margin-left:8px'>"
		str+="help</span><img src='img/closedot.gif' style='float:right' onclick='$(\"#helpDiv\").remove()'><br><br>";	
		str+="<iframe src='https://docs.google.com/document/d/e/2PACX-1vTXAsMJ-YlQaNtT49RtKvEnT5v5Xzz-TKPyVlo2px-23vDt-4lZFB7JujSKyDXs38hiSMISQoulYXB5/pub?embedded=true' ";
		str+="style='border: 1px solid #999;width:100%;height:"+(h-154)+"px' scrolling='yes'></iframe></div>";
		$("body").append(str);																	// Add to body
		$("#helpDiv").show("slide",{ direction:"down" });										// Slide up
		if (!isMobile)	$("#helpDiv").draggable();												// Make it draggable on desktop
		$("#helpDiv").on("mousedown touchdown touchmove", (e)=> { e.stopPropagation() } );		// Don't move orbiter
		}

	OnPhrase(text) 																			// ON PHRASE UTTERED
	{
		if (text && text.match(/replay|playback/i) && text.match(/class/i)) { app.rec.Playback(); return; }		// Playback
		app.arc.Parse(text, null, (o)=> {															// Parse text
			var score=0;
			if (o.match(/who:Liza/i)) 			app.curStudent=3;									// Set current student
			else if (o.match(/who:Freddy/i)) 	app.curStudent=0;
			else if (o.match(/who:Robert/i)) 	app.curStudent=2;
			else if (o.match(/who:Sara/i)) 		app.curStudent=1;
			else if (o.match(/who:Class/i)) 	app.curStudent=-1;
			else if (o.match(/who:all/i)) 		app.curStudent=-2;
	
			if (text.match(/set goal to/i)) {														// If setting goal		
				app.lastGoal=app.curGoal;															// Save last goal
				app.curGoal=text.replace(/set goal to/i,"").trim().toUpperCase();					// Remove goal tag
				Prompt("Now focusing on the goal "+app.curGoal,5),									// Prompt
				Sound("ding");																		// Ding
				return;
				}
				
			if (app.pickingStudent) {																// If students have their hands up
				var txt;
				if (app.curStudent < 0) app.curStudent=3;											// Default to Liza if still talking to class
				app.DoAction("sit",true);															// Hands down
				var r=app.arc.MarkovFindResponse(app.pickingStudent,app.curStudent);				// Get and save right response
				if (r)	txt=app.arc.tree[app.pickingStudent].res[r-1],app.voice.Talk(txt);			// If something to say
				else 	txt=app.students[app.curStudent].id+" didn't repond to you!",Prompt(txt,5),Sound("delete"); // Show student didn't respond
				app.rec.Add({ o:'R', text:txt, who:app.curStudent, res:r });						// Add to record
				app.pickingStudent="";																// Clear flag
				Prompt("");																			// Clear prompt
				return;	
				}
			app.arc.FindClosestARC(text,o);														// Match closest ARC to text
			if (app.arc.curArc)		score=app.arc.tree[app.arc.curArc].score;					// Get match score			
			app.rec.Add({ o:'S', t:app.voice.talkStartTime, text:text, ent:o, arc:app.arc.curArc, score:score });	// Add to record at time of STT listening
			if (o.match(/action:/i)) 	app.DoAction((o+" ").match(/action:(.+?) /i)[1]);		// If an action mentioned, try to do it
			app.arc.DeliverResponse(app.arc.curArc);											// Deliver response
			});																		
		}
		
		DoAction(act, all)																			// PERFORM ACTION
		{
			var i;
			if ((app.curStudent < 0) || all) 														// If the whole class
				for (i=0;i<this.students.length;++i)												// For each student
					animateIt(i);																	// Animate them									
			else																					// Just one
				animateIt(app.curStudent);															// Animate that one	

			function animateIt(student) {															// ANIMATE STUDENT
				var mod=app.students[student].id;													// Get model id
				if (act.match(/sleep/i))	 		app.sc.StartAnimation(mod,app.seqs["sleep"]);	// Route on action type							
				else if (act.match(/sit/i))	 		app.sc.StartAnimation(mod,app.seqs["sit"]);							
				else if (act.match(/stand/i))		app.sc.StartAnimation(mod,app.seqs["standUp"]);								
				else if (act.match(/handUp/i)) 		app.sc.StartAnimation(mod,app.seqs["armUp"]);								
				else if (act.match(/handDown/i)) 	app.sc.StartAnimation(mod,app.seqs["armDown"]);								
				else if (act.match(/nodYes/i))		app.sc.StartAnimation(mod,app.seqs["nodYes"]);								
				else if (act.match(/nodNo/i))		app.sc.StartAnimation(mod,app.seqs["nodNo"]);								
				else if (act.match(/wave/i))		app.sc.StartAnimation(mod,app.seqs["wave"]);						
				else if (act.match(/headUp/i))		app.sc.StartAnimation(mod,app.seqs["headUp"]);								
				else if (act.match(/headDown/i)) 	app.sc.StartAnimation(mod,app.seqs["headDown"]);									
				else if (act.match(/headLeft/i))	app.sc.StartAnimation(mod,app.seqs["headLeft"]);								
				else if (act.match(/headCenter/i)) 	app.sc.StartAnimation(mod,app.seqs["headCenter"]);									
				else if (act.match(/headRight/i))	app.sc.StartAnimation(mod,app.seqs["headRight"]);								
				else if (act.match(/fidgetStop/i))	app.students[student].fidget=0;							
				else if (act.match(/fidget/i))		app.students[student].fidget=1;							
				else if (act.match(/twistLeft/i))	app.sc.StartAnimation(mod,app.seqs["twistLeft"]);								
				else if (act.match(/twistRight/i))	app.sc.StartAnimation(mod,app.seqs["twistRight"]);								
				else if (act.match(/say/i))	 		app.voice.Talk("My name is "+mod+". How are you today?");	
				}					
			}

} // App class closure






///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// RECORD
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class Record  {																					

	constructor()   																				// CONSTRUCTOR
	{
		this.record=[];																					// Holds record of actions
		this.inPlayback=false;																			// In playback mode
	}

	Add(event)																						// ADD EVENT TO RECORD
	{
		if (!event.t)	event.t=new Date().getTime();													// Capture time, if not already done
		this.record.push(event);																		// Add to array																	
	}

	Playback()																						// PLAYBACK ACTION IN RECORD
	{
		var i,o,now,s=0;
		var _this=this;																					// Save context
		var sTimer=setInterval(actions,24);																// Set time
		this.inPlayback=true;																			// In playback mode
		app.sc.SetCamera(0,150,500,-.291457,0,0);														// Reset camera
		for (i=0;i<app.students.length;++i)																// For each student
			app.sc.SetPose(app.students[i].id,"startUp",20);											// Return to startup pose
		app.bb.Playback({ o:'B', s:0, m:0 });															// Close bb editor, set to left side
		app.bb.Playback({ o:'C', s:0 }); app.bb.Playback({ o:'C', s:1 });								// Clear bbs																		
		var off=new Date().getTime()-app.startTime;														// Get offset from 1st event
		function actions() {																			// PERFORM ACTIONS IN RECORD
			if (s >= _this.record.length)	{															// If done
				clearInterval(sTimer);																	// Kill timer
				_this.inPlayback=false;																	// Turn it off
				return;
				}
			now=new Date().getTime()-off;																// Get now
			for (i=s;i<_this.record.length;++i) {														// For each action
				o=_this.record[i];																		// Point at segment
				if (now < o.t) 				break;														// If before time of action quit
				if (now >= o.t)				++s;														// Done this one
				if (o.o == 'S')				app.voice.Talk(o.text,"instructor");						// Speaking if S
				else if (o.o == 'R')		app.voice.Talk(o.text,o.who);								// Responding if R
//				else if (o.o == 'C')		app.sc.SetCamera(o.x,o.y,o.z,o.xr,o.yr,o.zr);				// Move camera if O
				else						app.bb.Playback(o);											// Draw segment	if B, M, D, E, U, T, X, P, or C		
				}
			}	
	}

} // Record class closure


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// REVIEW
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class Review  {																					

	constructor()   																				// CONSTRUCTOR
	{
		this.overview="No overview provided";															// Overview
		this.mode="Overview";																			// Start off in overview
	}

	Reviewer()																						// REVIEW LESSON PLAN SCRIPT												
	{
		var i,w,o;
		if ($("#reviewDiv").length) {																	// If already up, bring it down
			$("#reviewDiv").hide("slide",{ direction:"down", complete: ()=>{ $("#reviewDiv").remove(); } }); // Slide down
			return;																						// Quit																					
			}
		var str="<div id='reviewDiv' class='lz-dialog' 	style='background-color:#ccc;";
		str+="width:298px;overflow:hidden;display:none;padding:8px;left:calc(100vw - 330px);top:calc(50vh - 154px)'>";
		str+="<img src='img/lizalogo.png' style='vertical-align:-6px' width='64'><span style='font-size:18px;margin-left:8px;padding-bottom:30px'>"
		str+="Lesson plan</span><img src='img/closedot.gif' style='float:right' onclick='$(\"#reviewDiv\").remove()'>";	
		str+="<div id='revBodyDiv'style='height:50vh;width:280px;background-color:#fff;padding:8px;border-radius:6px;overflow-y:auto;margin-top:8px'></div>"; 
		str+="<div style='width:100%;font-size:10px;color:#666;text-align:center;margin: 8px 0 0 0'>";
		str+=MakeSelect("revMode",false,["Overview","Hints","Full plan","Review"])+"</div>"; 

		$("body").append(str);																			// Add to body
		refreshBody(this.mode);																			// Fill content

		$("#reviewDiv").show("slide",{ direction:"down" });												// Slide up
		$("#reviewDiv").draggable();																	// Make it draggable on desktop
		$("#reviewDiv").on("mousedown touchdown touchmove", (e)=> { e.stopPropagation() } );			// Don't move orbiter

		$("#revMode").on("change", function(e) {														// On change mode
			app.rev.mode=this.value;																	// Change mode
			refreshBody(this.value);																	// Refresh body content
			});

		$("[id^=revStep-]").on("click", function(e) {													// On click of instructor event
			var id=e.target.id.substr(8);																// Get id of event
			app.bb.Playback({ o:'C', s:1 }); app.bb.Playback({ o:'C', s:0 });							// Clear blackboards																		
			for (i=0;i<app.rec.record.length;++i) {														// For each event
				o=app.rec.record[i];																	// Point at event
				if (o.t > app.rec.record[id].t)															// If past clicked event
					break;																				// Quit drawing													
				if (o.o != 'B')	app.bb.Playback(o);														// Draw if a draw event, if not open or close
				}
			});

		function refreshBody(mode) {																// REFRESH BODY CONTENT
			app.rev.overview
			var str="<div style='text-align:center'><b>Overview</b></div><hr>"+app.rev.overview+"<br>";	// Overview
			if (mode == "Review")	{																	// Session review
				str+="<hr><b>Session review</b><hr>";													// Title
				for (i=0;i<app.rec.record.length;++i) {													// For each event
					o=app.rec.record[i];																// Point at event
//		str+="<div style='width:100%;font-size:10px;color:#666;text-align:center;margin: 6px 0 0 0'><i>Click box to see backboard at time></i></div>"; 
					if (o.o == 'S') {																	// Instructor
						str+="<div class='lz-textS' id='revStep-"+i+"' ";								// Start div
						str+=" title='Entities are "+o.ent;												// Tooltip
						if (o.arc)	str+="\n"+Math.floor(o.score*100)+"% match with "+o.arc+"\nEntities are "+app.arc.tree[o.arc].ents+"";	// Arc and entities
						str+="'>"+o.text+"</div>";
						}
					else if (o.o == 'R') {																// Student
						w=(o.who == null) ? ""  : app.students[o.who].id; 								// Student name
						str+="<div style='text-align:right;width:100%;margin:-16px 0 24px 0'>";			// Enclosing div
						str+="<span style='float:right;color:#ccc'><i>"+w+"</i>&nbsp;</span><br>";		// Who's talking
						str+="<span class='lz-textR' title='"+o.res+"'>"+(o.text ? o.text : "Nobody responded")+"</span><br></div><br>";	// Response
						}
					}
				}
			else if (mode == "Hints")	{																// Gists
				str+="<hr><div style='text-align:center'><b>Step hints</b></div><hr><ul>";				// Title
				for (var arc in app.arc.tree) {															// For each ARC
					o=app.arc.tree[arc];																// Point at ARC
					if (o.gist)		str+="<li style='padding-bottom:4px'>"+o.gist+"</li>";				// Add gist
					}
				}
			else if (mode == "Full plan")	{															// Full plan
				str+="<hr><div style='text-align:center'><b>Full lesson plan</b></div><hr><ul>";		// Title
				for (i=0;i<app.students.length;++i) {													// Add student names
					str+="<li id='revTalk-"+i+"' style='padding-bottom:8px;cursor:pointer'>";			 
					str+="Yes, "+app.students[i].id+"</li>";											// Add text 
					}
				for (var arc in app.arc.tree) {															// For each ARC
					o=app.arc.tree[arc];																// Point at ARC
					if (o.text)	{																		// If defined
						str+="<li id='revTalk-"+arc+"' style='padding-bottom:8px;cursor:pointer'>";		// Add 
						str+=o.text+"</li>";															// Add text 
						}
					}
				}
	
			$("#revBodyDiv").html(str);																	// Add to div
			$("[id^=revTalk-]").off("click");															// Remove existing handlers
			$("[id^=revTalk-]").on("click", function(e) {												// On click of ARC step
				var id=e.target.id.substr(8);															// Get arc
				o=app.arc.tree[id];																		// Point at ARC
				if (isNaN(id))	o=o.text;																// If an ARC, deliver text from ARC
				else			o="Yes,  "+app.students[id].id;											// If number, respond to student
				app.voice.Talk(o,"instructor");															// Talk
				app.OnPhrase(o);	
				});
			}
	
		}

} // Review class closure


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// ARC
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class ARC  {																					

	constructor()   																				// CONSTRUCTOR
	{
		this.tree=[];																					// Holds ARC tree
		this.curArc="";																					// Current ARC "picked"
		this.threshold=.4;																				// ARC picking threshold		
		}

	Load(id) 																						// LOAD DOC FROM GOOGLE DRIVE
	{
		var _this=this;																					// Save context
		var str="https://docs.google.com/spreadsheets/d/"+id+"/export?format=tsv";						// Access tto
		var xhr=new XMLHttpRequest();																	// Ajax
		xhr.open("GET",str);																			// Set open url
		xhr.onload=function() { 																		// When loaded
			var i,j,o,v,id,step=0;
			var last="",goal="";
			_this.tree=[];																				// Clear tree
			var tsv=xhr.responseText.replace(/\r/g,"");													// Remove CRs
			tsv=tsv.split("\n");																		// Split into lines
			for (i=1;i<tsv.length;++i) {																// For each line
				v=tsv[i].split("\t");																	// Split into fields
				if (v[1] == "A") {																		// New action
					if (v[0] && isNaN(v[0])) 	goal=v[0].toUpperCase(),step=0; 						// Whole new goal
					else						step++;													// New step
					o=_this.tree[goal+"-"+step]={ con:[], rso:null, aso:null, cso:null, }; 				// A new ARC
					o.text=v[3];																		// Add text
					o.res=["",""];																		// Responses										
					o.gist=v[2];																		// Get gist
					o.next=["","",v[5] ? v[5] : ""];													// Add nexts
					for (j=0;j<3;++j) 																	// For each next of last ARC
						if (last && !_this.tree[last].next[j])	_this.tree[last].next[j]=goal+"-"+step;	// If last ARC had no nexts in this slot, use this one
					last=goal+"-"+step;																	// A new last arc
					}
				else if (v[1].match(/R[+|-]/i)) { 														// Response
					j=v[1].match(/R-/i) ? 1 : 0;														// 0=right, 1=wrong
					o.res[j]=v[3];																		// Set response
					if ((v[5] != "") && isNaN(v[5]))  	o.next[j]=v[5]+"-0";							// A goal, add post fix
					else if (v[5])						o.next[j]=goal+"-"+v[5];			  			// Use current goal and add step
					}
				else if (v[1].match(/ov/i))  app.rev.overview=v[3];										// Overview
					}
			_this.Extract();																			// Extract keywords and entities
			};									
		xhr.send();																						// Do it
		
		xhr.onreadystatechange=function(e) { 															// ON AJAX STATE CHANGE
			if ((xhr.readyState === 4) && (xhr.status !== 200)) {  										// Ready, but no load
				Sound("delete");																		// Delete sound
				PopUp("<p style='color:#990000'><b>Couldn't load Google Doc!</b></p>Make sure that <i>anyone</i><br>can view it in Google",5000); // Popup warning
				}
			};		
		}

	Extract()																						// EXTRACT KEYWORDS AND ENTITIES FROM ARC
	{
			var i,j,o,v,val;
			var _this=this;																				// Save context
			for (var arc in this.tree) {																// For each ARC in tree
				o=this.tree[arc];																		// Point at ARC
				o.keys=[];																				// Create keyword array
				v=(o.text+" ").match(/\(.+?\)/g);														// Get array of key words (keyword)
				if (v) {																				// If keys flagged
					for (i=0;i<v.length;++i) {															// For each key
						val=v[i].substr(1,v[i].length-2);												// Extract text
						o.keys.push(val);																// Add to keys
						o.text=o.text.replace(RegExp(v[i].replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")),val);	// Remove ()'s
						}
					}
				app.arc.Parse(o.text,o);																// Parse first text portion
				
				if (o.con.length) {																		// If consquences
					for (i=0;i<o.con.length;++i) {														// For each consequence
						o.con[i].keys=[];																// Create keyword array
						v=(o.con[i].text+" ").match(/\(.+?\)/g);										// Get array of key words (keyword)
						if (v) {																		// If keys flagged
							for (j=0;j<v.length;++j) {													// For each key
								val=v[j].substr(1,v[j].length-2);										// Extract text
								o.con[i].keys.push(val);												// Add to keys
								o.con[i].text=o.text.replace(RegExp(v[i].replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&")),val);	// Remove ()'s
								}
							}
						app.arc.Parse(o.con[i].text, o.con[i]);											// Parse consequence text portion
						}
					}
				}
		}

		FindClosestARC(text, entities)																// FIND ARC CLOSEST TO TEXT + ENTITIES
		{
			var o,i,n,str="";
			var kscore,escore,best="";
			entities=(""+entities).split(", ");															// Put entities into array
			for (var arc in this.tree) {																// For each ARC in tree
				kscore=0;																				// Start at 0
				o=this.tree[arc];																		// Point at ARC
				for (i=0;i<o.keys.length;++i)															// For each key
					if (text.match(RegExp(o.keys[i].replace(/[-[\]{}()*+?.,\\^$|#\s]/g,"\\$&"))))		// Check for key in text
						kscore++;																		// Add to key score
				escore=0;																				// Start at 0
				for (i=0;i<entities.length;++i) {														// For each entity spoken
					if (o.ents.match(RegExp(entities[i].split(':')[0].replace(/[-[\]{}()*+?.,\\^$|#\s]/i))))  // If a basic enities match
						escore+=.5;																		// Add to score
					if (o.ents.match(RegExp(entities[i].replace(/[-[\]{}()*+?.,\\^$|#\s]/i)))) 			// If a entity AND value match
						escore+=.5;																		// Add to score
					}
				n=(""+o.ents).split(", ").length;														// Number of entities in ARC	
				this.tree[arc].kscore=kscore;															// Save kscore
				this.tree[arc].matched=escore/Math.max(n,entities.length);								// Adjust by amount matched
				if (entities.length)	escore=escore/entities.length;									// Normalize 0-1
				this.tree[arc].score=this.tree[arc].matched;											// Save score 
				this.tree[arc].escore=escore;															// Save escore
				if (o.keys.length)	this.tree[arc].score=(this.tree[arc].matched+(kscore/o.keys.length))/2;	// Average of both
//				if (app.curGoal && arc.match(RegExp(app.curGoal)))	this.tree[arc].score+=.25;			// If in current goal, bump-up score 
				}
			n=0;																						// Start low
			for (var arc in this.tree) 	{																// For each ARC in tree
				if (this.tree[arc].score >= n) { n=this.tree[arc].score;	best=arc };					// Set if highest
				str+=arc+" - "+Math.round(this.tree[arc].score*100) + "%\n";
				}
			this.curArc=(n > this.threshold) ? best : "";												// Set ARC if above threshold
			str+="\n= ["+best+"] "+this.tree[best].ents; trace(str); 															
			if (this.curArc)					app.curGoal=best;										// Set current goal if past threshold	
			if (app.curGoal != app.lastGoal) 	app.lastGoal=app.curGoal;								// Save last goal
			return this.curArc;																			// Return best fit
		}

	DeliverResponse(arc)																			// DELIVER RESPONSE
	{
		var i,j,n,r,so;
		var text="";
		if (!arc)	return;																				// Quit if no ARC
		if (app.curStudent == -1) {																		// If whole class responding and looking for answer
			var n=Math.floor(Math.random()*app.students.length);										// Random number of students responding
			var j=Math.floor(Math.random()*app.students.length);										// Random start	
			for (i=0;i<n;++i)																			// For each responder	
				app.sc.StartAnimation(app.students[++j%app.students.length].id,app.seqs["wave"]);		// Make them wave
			if (n) {																					// If someone responded
				Prompt("Choose a student to respond...",10); 											// Ask to choose a student
				app.pickingStudent=arc;																	// Send this message
				Sound("ding");																			// Ding
				}
			else{																						// Noone reponded
				text="Nobody reponded to you!";															// Message
				app.rec.Add({ o:'R', who:null, text:"", res:0 });										// Add to record
				Prompt(text,5); 																		// Show prompt				
				Sound("delete");
				}
			}
		if (app.curStudent == -2) {																		// If whole class responding with nods
			for (i=0;i<app.students.length;++i)															// For eac hstudent
				if (this.MarkovFindResponse(arc,i) == 1)												// If right
					app.sc.StartAnimation(app.students[i].id,app.seqs["nodYes"]);						// Nod yes
			}
		else{																							// A single student responding
			r=this.MarkovFindResponse(arc,app.curStudent);												// Get, compute, and save right response to ARC
			if (r)	text=this.tree[arc].res[r-1],app.voice.Talk(text);									// If something to say
			else 	text=app.students[app.curStudent].id+" didn't repond to you!",Prompt(text,5),Sound("delete"); // Show student didn't respond
			app.rec.Add({ o:'R', text:text, who:r ? app.curStudent : null, res:r });					// Add to record
			}
		}
		
	MarkovFindResponse(arc, sid) 																	// FIND RESPOSE USING MARKOV CHAIN
	{	
		var so;
		var ability=app.students[sid].ability;															// Get student ability
		var r=(Math.random()-.5)*.1;																	// Get jitter factor
		var tm=[ [0.0, .40, .60], [0.0, .55-r, .45+r], [0.0, .46, .54] ];								// Markov transition matrix
		if (app.students[sid].rMatrix[arc])	{															// If been there already,
			so=app.students[sid].rMatrix[arc];						 									// Use last stage matrix as starting matrix
			so=MatrixMultiply(so,tm);																	// Get response matrix stage
			}
		else{																							// First response is random, based on ability/affect
			r=Math.random();																			// Get random number
			if (r*ability < .03)	so=[[1,0,0]];														// Force a none response ~20% proportional to ability
			else{																						// Calc starting matrix
				r=Math.max(Math.min(ability+((r-.5)*(1+ability)),1),0); 								// Calc chance of right answer capped 0-1
				so=[[0,r,1-r]];																			// Set starting matrix
				}
			}
		app.students[sid].rMatrix[arc]=so;																// Save for later responses
		trace("Score:"+app.arc.tree[arc].score.toFixed(2)+" Entities:"+app.arc.tree[arc].escore.toFixed(2)+" Match:"+app.arc.tree[arc].matched.toFixed(2)+" Keywords:"+app.arc.tree[arc].kscore.toFixed(2));	// Show results
		r=so[0].indexOf(Math.max(...so[0]));															// Convert [0=none, 1=right, 2=wrong]															
		return r;																						// Return type of response
	}

	Parse(text, data, callback)																		// PARSE TEXT STRING
	{
		if (!text)	return;																				// Quit if no text
		try {
			if (!window.location.search.match(/noai/i))													// Unless turned off
				$.ajax({ url: 'https://api.wit.ai/message',												// Send to WIT
					data: { 'q': text, "access_token":"YWNFSLOCAMKGLMSWEAZA5JZBSER6MJ4O" },				// Text and api id
					dataType: "jsonp", method: "GET",													// JSONP
					success: (r)=> {																	// When parsed
						trace(">>> "+r._text);
						var i,c,v,s="",str="";
						if (r.error) {																	// If an error
							trace("*****************\nWit error: "+r.error+"\n***********");			// Show error
							return;																		// Quit
							}	
						for (var entity in r.entities) {												// For each entity parsed
							str+=entity.toUpperCase()+": ";												// Print entity name
							for (i=0;i<r.entities[entity].length;++i) {									// For each entity instance
								v=r.entities[entity][i].value;											// Add value
								c=Math.floor(r.entities[entity][i].confidence*100);						// Confidence
								s+=entity+":"+v+", ";													// Add entities
								str+=v+" ";																// Print value and confidence
								}
							str+="\n";
							}
						trace(str+"\n");
						s=s.substr(0,s.length-2)														// Remove last comma
						if (data)		data.ents=s;													// Add to object
						if (callback) 	callback(s);													// Return entities to callback	
																						
						}
				});
		} catch(e) { trace("*****************\nWIT error: "+e.error+"\n***********"); }					// Show error
	}

} // ARC class closure


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////


	function DialogBox(title, content, width, callback, callback2) 								// DIALOG BOX
	{
		$("#dialogDiv").remove();												
		$("body").append("<div class='unselectable' id='dialogDiv'></div>");														
		var str="<p><img src='img/logo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span id='gtBoxTi'style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>"+title+"</b></span><p>";
		str+="<div style='font-size:14px;margin:14px'>"+content+"</div>";
		$("#dialogDiv").append(str);	
		$("#dialogDiv").dialog({ width:Math.abs(width), buttons: {
					            	"OK": 		function() { if (callback)
					            								callback(); 
					            								$(this).remove();  
					            								},
					            	"Cancel":  	function() { if (callback2)	            		
					            								callback2();
					            								$(this).remove(); }
									}});	
		if (width < 0)
			$("#dialogDiv").dialog("option","position",{ my:"left top", at:"left top", of:this.parent });
		else
			$("#dialogDiv").dialog("option","position",{ my:"center", at:"center", of:this.parent });
	}

	function GetTextBox(title, content, def, callback)											// GET TEXT LINE BOX
	{
		$("#alertBoxDiv").remove();																	// Remove any old ones
		$("body").append("<div id='alertBoxDiv'></div>");														
		var str="<p><img src='lizalogo.png' width='32' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span id='gtBoxTi'style='font-size:18px'><b>"+title+"</b></span><p>";
		str+="<div style='font-size:12px;margin:14px'>"+content;
		str+="<p><input class='lz-is' style='width:75%' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='lz-bs'>OK</div>";
		str+="<div id='dialogCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ width:400 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center" });
		$("#alertBoxDiv").css({ border:"1px solid #999","border-radius":"6px"});

		$("#dialogOK").on("click", function() {														// ON OK BUT
					callback($("#gtBoxTt").val());
					$("#alertBoxDiv").remove();  
				});

		$("#dialogCancel").on("click", function() {													// ON CANCEL BUT
				$("#alertBoxDiv").remove();															// Remove 
				});

		}

	function ConfirmBox(title, content, callback, callback2)										// CONFIRMATION BOX
	{
		Sound("ding");																					// Ding sound
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv'></div>");														
		var str="<img src='img/lizalogo.png' width='32' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:18px; color:#666'><b>"+title+"</b></span><br>";
		str+="<p>"+content+"<p>";
		str+="<div style='float:right'><div id='confirmOK' class='lz-bs'>OK</div>";
		str+="<div id='confirmCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);	
	
		$("#confirmOK").on("click", function() {														// ON OK BUT
				$("#confirmBoxDiv").remove();															// Remove 
				if (callback)	callback();																// If callback defined, run it
				});

		$("#confirmCancel").on("click", function() {													// ON CANCEL BUT
				$("#confirmBoxDiv").remove();															// Remove 
				if (callback2)	callback();																// If callback defined, run it
				Sound("delete");																		// Delete sound
				});
	}

	function PopUp(msg, time, div)																	// TIMED POPUP
	{
		var str="";
		$("#popupDiv").remove();																		// Kill old one, if any
		str+="<div id='popupDiv' class='lz-popup'>"; 													// Add div
		if (time == -1) {																				// If has close but
			time=100000;																				// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";		// Add close button
			}
		str+=msg+"</div>"; 																				// Add div
		$(div ? "#"+div : "body").append(str);															// Add popup to div or body
		$("#pu-close").click(function() { $("#popupDiv").remove(); });									// Remove on click of close but
		$("#popupDiv").fadeIn(500).delay(time ? time : 3000).fadeOut(500)								// Animate in and out		
	}

	function Prompt(msg, secs)																		// TIMED PROMPT
	{
		var str="";
		$("#promptSpan").html(msg);																		// Add message
		if (secs == "on") 																				// If on	
			$("#promptSpan").fadeIn(200);																// Fade in
		else																							// Popping up	
			$("#promptSpan").fadeIn(500).delay(secs ? secs*1000 : 3000).fadeOut(500);					// Animate in and out		
	}

	function trace(msg, p1, p2, p3, p4)																// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function trace2(msg, p1, p2)																	// VISIBLE CONSOLE (FOR IOS)
	{
		msg+=(p1 != undefined) ? (","+p1) : ""; 														// Add with comma
		msg+=(p2 != undefined) ? (","+p2) : ""; 
		if (!$("#errorDiv")[0])																			// If not initted
			$("body").append("<div id='errorDiv' class='lz-error'></div>");								// Add div
		$("#errorDiv").append(msg+"<br> ");																// Print msg
		console.log(msg);																				// On console too
	}

	function Sound(sound, mute)																		// PLAY SOUND
	{
		var snd=new Audio();																			// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)											// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");								// Use built in mp3
		if (!mute)	{																					// If not initing or muting	
			snd.volume=100/100;																			// Set volume
			snd.play();																					// Play it
			}
		}
		
	function MakeSelect(id, multi, items, sel, extra, values)										// CREATE HTML SELECT
	{
		var	str="<select class='lz-is' style='width:auto' id='"+id+"'";									// Header
		str+=" data-lastselect='"+(sel ? sel : '')+"' ";												// Init last selected
		if (multi)																						// Multi select
			str+="multiple='multiple' size='"+multi+"'";												// Add flag
		if (extra)																						// If extra param
			str+=extra;																					// Add them
		str+=">";																						// End header
		for (i=0;i<items.length;++i) {																	// For each option
			str+="<option";																				// Add tag
			if (values && values[i]) {																	// If has a value
				str+=" value='"+values[i]+"'";															// Add it
				if (sel == values[i])	str+=" selected='selected'"										// If value selected, add tag
				}
			else if (sel == items[i])	str+=" selected='selected'"										// If name selected, add tag
			str+=">"+items[i]+"</option>";																// End option
			}	
		return str+"</select>";																			// End select				
	}

	function TraceMatrix(mat) 																		// PRINT MATRIX ON CONSOLE
	{
		var i,j,str="--N--  --R--  --W--\n"
		for (i=0;i<mat.length;++i) {																	// For each row	
			for (j=0;j<mat[0].length;++j)																// For each col
				str+=mat[i][j]=mat[i][j].toFixed(3)+"  ";												// Cap decimals
			str+="\n";																					// New row
			}
		trace(str); 																					// Show it
	}

	function MatrixMultiply(a, b) 																	// MULTIPLY TWO MATRICES
	{
		var i,m,r,c;
		var aNumRows=a.length, aNumCols=a[0].length;													// A matrix sizes
      	var bNumRows=b.length, bNumCols=b[0].length;													// B
      	m=new Array(aNumRows);  																		// Initialize array of rows
  		for (r=0;r<aNumRows;++r) {																		// For each A row
    		m[r]=new Array(bNumCols); 																	// Initialize the current row
			for (c=0;c<bNumCols;++c) {																	// For each B column
				m[r][c]=0;            																	// Initialize the current cell
				for (i=0;i<aNumCols;++i) {																// For each A column
					m[r][c]+=a[r][i]*b[i][c];															// Sum it
					}
				}
			}
 	 	return m;																						// Return multiplied matrix
	}
	

</script>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=UA-133670235-1"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());
  gtag('config', 'UA-133670235-1');
</script>
</body>
</html>
