<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8" />
	<link REL="SHORTCUT ICON" HREF="img/favicon.ico">
	<title>liza</title>
	<meta name="viewport" content="width=device-width">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
	<link   rel="stylesheet" href="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>	
	<script src="lib/wgl/three.min.js"></script>
	<script src="lib/wgl/OBJLoader.js"></script>
	<script src="lib/wgl/OrbitControls.js"></script>

	
	<script src="lib/jquery.ui.touch-punch.min.js"></script>
	<style>
		 body { 			font-family:Verdana,Geneva,sans-serif;font-size:13px; box-sizing:border-box; 
							padding:0;margin:0; 
							}
		.lz-splash { 		width:100%; color:#999; text-align:center; margin-top:10%;  display:none;
							}
		.lz-about { 		position: relative; width:100%; max-width:800px; height:calc(100vh - 28px); margin: 12px auto; border:none; 
							}
		.lz-main { 			width:100%; height:100%; background-color: #ddd; display:none; text-align:center;
							}
		.lz-confirm {		position: absolute;  width: 300px; padding: 16px; left: calc(50% - 150px); top: calc(50% - 50px); user-select: none;	
							border-radius: 8px; background-color: #fff; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							}
		.lz-popup {			position: absolute;  width: auto; padding: 12px; left: calc(50% - 100px); top: calc(50% - 50px);
							border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
							font-size: 14px; text-align:center; display: none;
							}
		.lz-is {			border-radius:.8em;padding-left:.6em;padding-right:.6em;padding-top:1px;
							border:1px solid #999; font-size:1em; height: 1.66em; width:16.66em;
							}
		.lz-bs {			cursor: pointer; color:#fff; 
							text-align: center; border-radius: 16px; display: inline-block; user-select: none;
							font-size: 12px; background-color: #27ae60; padding: 2px 8px 2px 8px; vertical-align:3px;
							}
		 table {			border-spacing: 0px;  }

</style>
</head>
<body>
	
	<div id="mainDiv" class="lz-main">
		</div>
	<div id="splashDiv" class="lz-splash">
		<img src="img/lizalogo.png" style='width:25%;opacity:.66;' alt=""><br><br>
		<br><p style="color:#000;font-size:14px"><em>A tool for engaging people in highly affective script-driven discourse<br>for learning and practicing goal-directed behaviors.</em></p>
	</div>

<script>
	
class Scene {

	constructor()																				// CONSTRUCTOR
	{
		this.container=$("#mainDiv")[0];															// Div container														
		this.camera=null;																			// Camera object
		this.renderer=null;																			// Renderer object
		this.scene=null;																			// Holds scene
		this.controls=null;																			// Controls object
		this.floor="wood.jpg";																		// Floor texture
		this.frontWall="";																			// Wall texture
		this.backWall="";																			// Wall texture
		this.leftWall="";																			// Wall texture
		this.tightWall="";																			// Wall texture
		this.Init();																				// Init 3D system
	}

	Init()																						// INIT 3D SYSTEM
	{
		this.scene=new THREE.Scene();																// Alloc new scene
		this.manager=new THREE.LoadingManager();													// Loading manager
		this.manager.onProgress=function(item, loaded, total ) { console.log(item,loaded,total); };	// Show progress
		this.textureLoader=new THREE.TextureLoader();												// Texture loader
		this.AddCamera(0,200,500,.4);																// Add camera
		this.renderer=new THREE.WebGLRenderer();													// Init renderer
		this.renderer.setPixelRatio(window.devicePixelRatio);										// Set ratio
		this.AddLights();																			// Add lights
		this.Resize();																				// Resize 3D space
		this.container.appendChild(this.renderer.domElement);										// Add to div
		this.AddRoom();																				// Add room walls
	}

	AddLights()																					// ADD LIGHTS
	{
		var directionalLight=new THREE.DirectionalLight("#333333");									// Made directional light
		directionalLight.position.set(0,0,1);														// Set angle
		this.scene.add(directionalLight);															// Add directioal light
		this.scene.add(new THREE.AmbientLight(0xcccccc, 0.8));										// Add ambient light
	}

	Resize()																					// RESIZE 3D SPACE
	{
		this.camera.aspect=window.innerWidth/window.innerHeight;									// Set aspect
		this.camera.updateProjectionMatrix();														// Reset matrix
		this.renderer.setSize(window.innerWidth,window.innerHeight-3);								// Reset render size
	}

	AddCamera(x, y, z, light)																	// ADD CAMERA
	{
		this.camera=new THREE.PerspectiveCamera(45,window.innerWidth/window.innerHeight,1,2000);	// Add 45 degree POV
		this.camera.position.x=x;	this.camera.position.y=y;	this.camera.position.z=z;			// Camera position
		this.scene.add(this.camera);																// Add camera to scene
		this.controls=new THREE.OrbitControls(this.camera);											// Add orbiter control
		this.controls.damping=0.2;																	// Set dampening
	}

	AddRoom()																					// ADD ROOM TO SCENE
	{	
		if (this.floor) {																			// If a floor spec'd
			var tex=this.textureLoader.load(this.floor);											// Load texture
			tex.wrapS=tex.wrapT=THREE.RepeatWrapping;												// Wrap and repeat
			tex.repeat.set(4,4);																	// 4 by 4
			var mat=new THREE.MeshPhongMaterial({ map:tex });										// Make material
			var cbg=new THREE.PlaneGeometry(1024,1024,1,1);											// Make grid
			var mesh=new THREE.Mesh(cbg,mat);														// Make mesh
			mesh.rotation.x=-Math.PI/2;																// Rotate to bottom
			this.scene.add(mesh);																	// Add to scene		
			}
		}

	AddModel(src, x, z, y, scale, rot)															// ADD MODEL TO SCENE
	{
		var loader;
		var _this=this;																				// Save context
		if (src.match(/json/i))	loader=new THREE.ObjectLoader(this.manager);						// If JSON model format
		if (src.match(/obj/i))	loader=new THREE.OBJLoader(this.manager);							// If OBJ
		loader.load(src, (obj)=> { loadModel(obj) }, onProgress, onError );							// Load

		function onProgress(xhr) {																	// On load progress event
			if (xhr.lengthComputable ) {															// If a length
				var percentComplete=xhr.loaded/xhr.total*100;										// Percent
				console.log( 'model ' + Math.round( percentComplete, 2 ) + '% downloaded');			// Message
				}
			}
		function onError(err) {	console.log(err) };													// On error

		function loadModel(object) {																		// On Load
			var texture=_this.textureLoader.load("lib/wgl/map.jpg");								// Get model texture
			object.traverse(function(child) {														// Go thru model
				if (child.isMesh) child.material.map=texture;										// If a texture, wrap it								
				});
			object.scale.x=object.scale.y=object.scale.z=scale;										// Scale up
			object.position.x=x;	object.position.y=y;	object.position.z=z;					// Position
			object.rotation.y=rot*Math.PI/180;														// Rotation
			_this.scene.add(object);																// Add model to scene
			}
	}																								// SCENE CLOSURE
}  // CLASS CLOSURE

	var sc=new Scene();	
	sc.AddModel("desk.json",-100,0,0,20,0);				
	sc.AddModel("desk.json",0,0,0,20,0)
	sc.AddModel("desk.json",100,0,0,20,30);				
	sc.AddModel("desk.json",-100,200,0,20,-10);				
	sc.AddModel("desk.json",0,200,0,20,5)
	sc.AddModel("desk.json",100,200,0,20,0);				


	animate();																				// Alloc scene	

	function animate() {														// ANIMATE LOOP
		sc.controls.update();														// Update control time
		requestAnimationFrame(animate);												// Set timer
		sc.renderer.render(sc.scene,sc.camera);												// Render
//		trace(sc.camera.position)
	}















































//////////////////////////////////////////////////////////////////////////////////////////////////
// MAIN 
/////////////////////////////////////////////////////////////////////////////////////////////////

var app=null;															// Holds app
var isMobile=false;														// Flag for mobile devices

$(window).resize(function() {                                         	// ON WINDOW RESIZE
	sc.Resize();															// Resize 3D
	if (app && app.allowResize)												// If app loaded and allowing resizing
		app.Draw();															// Redraw to fit screen
	});
			
$(document).ready(function() {								           	// ON PAGE LOADED
	var url=window.location.search.substring(1);						   	// Get query string
	app=new App(url);                                                      	// Alloc app
	isMobile=navigator.userAgent.match(/(ipad|iphone|ipod|android)/i) ? true : false; // Set mobile flag
	if ((window.location.host != "localhost") && (url != "preview")) {		// Not in debug or preview
		$("#splashDiv").fadeIn().delay(4000).fadeOut();						// Fade out splash
		$("#mainDiv").delay(4000).fadeIn(2000);								// Wait, and fade in main
		}	
	else																	// Debug
		$("#mainDiv").fadeIn(0);											// Load fast

	if (window.addEventListener) 											// If supported this way
		window.addEventListener("message",html5MessageHandler,false);		// Add event handler
	else																	// Use other method
		window.attachEvent("message",html5MessageHandler);					// Add handler

	$(window).on("keydown",function(e) {									// HANDLE KEYPRESS
		});
 
 });									

function html5MessageHandler(e)											// ON HTML5 MESSAGE
{
	if (e && e.data) 														// If a valid message				
		trace(e);												// Route
}


///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																								 // APP

	constructor(id)   																							// CONSTRUCTOR
	{
		app=this;
	}

	Draw(index) 																								// REDRAW
	{
	}
}


////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function DialogBox(title, content, width, callback, callback2) 			// DIALOG BOX
	{
		$("#dialogDiv").remove();												
		$("body").append("<div class='unselectable' id='dialogDiv'></div>");														
		var str="<p><img src='img/logo32.png' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span id='gtBoxTi'style='font-size:18px;text-shadow:1px 1px #ccc;color:#666'><b>"+title+"</b></span><p>";
		str+="<div style='font-size:14px;margin:14px'>"+content+"</div>";
		$("#dialogDiv").append(str);	
		$("#dialogDiv").dialog({ width:Math.abs(width), buttons: {
					            	"OK": 		function() { if (callback)
					            								callback(); 
					            								$(this).remove();  
					            								},
					            	"Cancel":  	function() { if (callback2)	            		
					            								callback2();
					            								$(this).remove(); }
									}});	
		if (width < 0)
			$("#dialogDiv").dialog("option","position",{ my:"left top", at:"left top", of:this.parent });
		else
			$("#dialogDiv").dialog("option","position",{ my:"center", at:"center", of:this.parent });
	}

	function GetTextBox(title, content, def, callback)					// GET TEXT LINE BOX
	{
		$("#alertBoxDiv").remove();											// Remove any old ones
		$("body").append("<div id='alertBoxDiv'></div>");														
		var str="<p><img src='img/scalelogo.png' width='32' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span id='gtBoxTi'style='font-size:18px'><b>"+title+"</b></span><p>";
		str+="<div style='font-size:12px;margin:14px'>"+content;
		str+="<p><input class='lz-is' style='width:75%' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='lz-bs'>OK</div>";
		str+="<div id='dialogCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#alertBoxDiv").append(str);	
		$("#alertBoxDiv").dialog({ width:400 });	
		$("#alertBoxDiv").dialog("option","position",{ my:"center", at:"center" });
		$("#alertBoxDiv").css({ border:"1px solid #999","border-radius":"6px"});

		$("#dialogOK").on("click", function() {							// ON OK BUT
					callback($("#gtBoxTt").val());
					$("#alertBoxDiv").remove();  
				});

		$("#dialogCancel").on("click", function() {						// ON CANCEL BUT
				$("#alertBoxDiv").remove();								// Remove 
				});

		}

	function ConfirmBox(title, content, callback, callback2)							// CONFIRMATION BOX
	{
		Sound("ding");																		// Ding sound
		$("#confirmBoxDiv").remove();														// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv'></div>");														
		var str="<img src='img/scalelogo.png' width='32' style='vertical-align:-10px'/>&nbsp;&nbsp;";								
		str+="<span style='font-size:18px; color:#666'><b>"+title+"</b></span><br>";
		str+="<p>"+content+"<p>";
		str+="<div style='float:right'><div id='confirmOK' class='lz-bs'>OK</div>";
		str+="<div id='confirmCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);	
	
		$("#confirmOK").on("click", function() {											// ON OK BUT
				$("#confirmBoxDiv").remove();												// Remove 
				if (callback)	callback();													// If callback defined, run it
				});

		$("#confirmCancel").on("click", function() {										// ON CANCEL BUT
				$("#confirmBoxDiv").remove();												// Remove 
				if (callback2)	callback();													// If callback defined, run it
				Sound("delete");															// Delete sound
				});
	}

	function PopUp(msg, time, div)											// TIMED POPUP
	{
		var str="";
		$("#popupDiv").remove();												// Kill old one, if any
		str+="<div id='popupDiv' class='lz-popup'>"; 							// Add div
		if (time == -1) {														// If has close but
			time=100000;														// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";	// Add close button
			}
		str+=msg+"</div>"; 														// Add div
		$(div ? "#"+div : "body").append(str);									// Add popup to div or body
		$("#pu-close").click(function() { $("#popupDiv").remove(); });			// Remove on click of close but
		$("#popupDiv").fadeIn(500).delay(time ? time : 2000).fadeOut(500)		// Animate in and out		
	}

	function trace(msg, p1, p2, p3, p4)										// CONSOLE 
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function Sound(sound, mute)												// PLAY SOUND
	{
		var snd=new Audio();													// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)					// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");		// Use built in mp3
		if (!mute)	{															// If not initing or muting	
			snd.volume=50/100;													// Set volume
			snd.play();															// Play it
			}
		}
		
	function ShortenString(str, len)										// SHORTEN A STRING TO LENGTH
	{
		if (str && str.length > len)											// Too long
			str=str.substr(0,(len-3)/2)+"..."+str.slice((len-3)/-2);			// Shorten	
		return str;																// Return string
	}

	function MakeSelect(id, multi, items, sel, extra, values)				// CREATE HTML SELECT
	{
		var	str="<select class='lz-is' style='width:auto' id='"+id+"'";			// Header
		str+=" data-lastselect='"+(sel ? sel : '')+"' ";						// Init last selected
		if (multi)																// Multi select
			str+="multiple='multiple' size='"+multi+"'";						// Add flag
		if (extra)																// If extra param
			str+=extra;															// Add them
		str+=">";																// End header
		for (i=0;i<items.length;++i) {											// For each option
			str+="<option";														// Add tag
			if (values && values[i]) {											// If has a value
				str+=" value='"+values[i]+"'";									// Add it
				if (sel == values[i])	str+=" selected='selected'"				// If value selected, add tag
				}
			else if (sel == items[i])	str+=" selected='selected'"				// If name selected, add tag
			str+=">"+items[i]+"</option>";										// End option
			}	
		return str+"</select>";													// End select				
	}
	

</script>
</body>
</html>
