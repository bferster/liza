<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=.75, shrink-to-fit=yes">
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <link rel="stylesheet" href="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/themes/smoothness/jquery-ui.css">
  <script src="//ajax.googleapis.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.css" />
  <link type="text/css" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid-theme.min.css" />
  <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jsgrid/1.5.3/jsgrid.min.js"></script>
  <script src="lib/papaparse.min.js"></script>
  <script src="witai.js"></script>
  
  <link REL="SHORTCUT ICON" HREF="img/favicon.ico">
  <title>Liza authoring tool</title>
</head> 
<style>
	body 		{ 	font-family:Segoe UI,Verdana,Geneva,sans-serif; font-size:12px; padding:0px; margin:16px; box-sizing:content-box; }
	.lz-bar		{	position:absolute; color:#000; text-align:center; width:100%; user-select:none; display:none;
					padding: 12px 0; top:66px; left:0; pointer-events: none; }
   	.lz-dialog 	{	position: absolute; top:16px; left:16px; background-color: #eee; border: 2px solid #aaa;
					padding:16px; border-radius: 16px; width:600px;	}
	.lz-confirm {	position: absolute;  width: 250px; padding: 16px; left: calc(50% - 125px); top: calc(50% - 150px); user-select: none;	
					border-radius: 8px; background-color: #fff; border: 1px solid #999; box-shadow: 2px 2px 4px 2px #aaa; }
	.lz-popup 	{	position: absolute;  width: auto; padding: 12px; left: calc(50% - 100px); top: calc(50% - 50px);
					border-radius: 8px; background-color: #eee; border: 1px solid #999; box-shadow: 4px 2px 12px 2px #aaa; 
					font-size: 14px; text-align:center; display: none; }
	.lz-is 		{	border-radius:12px; padding:1px 8px; border:1px solid #999; width:94px; font-size:12px; }
	.lz-bs 		{	cursor: pointer; color:#fff; text-align: center; border-radius: 16px; display: inline-block; user-select: none;
					font-size: 13px; background-color:  #999; padding: 0 8px 2px 8px; }
	#lz-tab		{ background:transparent;  border:none; margin-left:-8px; }
	#lz-tab .ui-widget-header { background:transparent; border:none; background-color: #ccc; } 
	#lz-tab .ui-tabs-nav .ui-state-default { background:transparent; border:none;  }
	#lz-tab .ui-tabs-nav .ui-state-default a { color: #888; font-size:24px; }
	#lz-tab .ui-tabs-nav .ui-state-active a {  color: #fff; font-weight:bold;font-size:24px; outline:none; }

	body ::-webkit-scrollbar { width: 9px; height:8px } 
	body ::-webkit-scrollbar-track { background: transparent; }
	body ::-webkit-scrollbar-thumb { border-radius:8px ;background:#a4baec }
	body ::-webkit-scrollbar-thumb:hover { background: #a4baec }
</style>

<body>
	<img style="float:right;width:80px" src="img/lizalogo.png">
	<img id="lz-dashHelp" style="float:left;width:20px;margin-top:8px;cursor:pointer" src="img/help.png">
	<div id="lz-sessionName" style="text-align:center;font-size:30px;color:#999;font-weight:bold;margin:-8px 0 4px 0"></div>
	<div id="lz-tab">
		<ul>
			<li id="lz-tab1"><a href="#sessionEditor">SESSION</a></li>
			<li id="lz-tab2"><a href="#remarksEditor">REMARKS</a></li>
			<li id="lz-tab3"><a href="#responsesEditor">RESPONSES</a></li>
			<li id="lz-tab4"><a href="#studentEditor">STUDENTS</a></li>
			<li id="lz-tab5"><a href="#jsGridData">DATA</a></li>
		</ul>
		<div id="sessionEditor"></div>
		<div id="remarksEditor" style="padding:0"></div>
		<div id="sessionEditor" style="padding:0"></div>
		<div id="studentEditor"></div>
		<div id="jsGridData"></div>
	</div>	
	<input type="file" id="lz-tempFile" style="display:none">
	<div id="lz-tData" class="lz-bar">
		<div style="float:right;margin-right:36px; pointer-events:all">
			<div class="lz-bs"  id="lz-importData">Import CSV</div>
			&nbsp;&nbsp;&nbsp;<div class="lz-bs"  id="lz-exportData">Export CSV</div>
			&nbsp;&nbsp;&nbsp;Show&nbsp;&nbsp;<select id="lz-dataFilter" class="lz-is">
				<option>All</option>
				<option>Remarks</option>
				<option>Responses</option>
				<option>Intents</option>
				<option>Traits</option>
				<option>Responses</option>
				<option>Students</option>
			</select>
			&nbsp;&nbsp;&nbsp;<div class="lz-bs"  id="lz-saveData" style="float:right;background-color:#009966">Save</div>
		</div>
	</div>
	<textarea id='clipOutputDiv' style='width:1px;height:1px;opacity:.01'></textarea>

<script>

	let app=null;
	if ((location.protocol != 'https:') && (window.location.host != "localhost")) location.href = 'https:' + window.location.href.substring(window.location.protocol.length); // FORCE HTTPS!

	$(document).ready(function() {								           							// ON PAGE LOADED
		$("#lz-tab" ).tabs();																		// Init tabs
		app=new App();                                      										// Alloc app
//		Login((e, p, m)=>{ /* app.ws.send(`I|${e}|${p}|${m}`); */ });								// Send login data to WS
		$("#lz-sessionName").text("SESSION ID: " +app.sessionId);									// Set title
		$("#lz-dashHelp").on("click",()=> { 														// ON HELP
//			window.open("https://docs.google.com/document/d/1MzQp9xoYiREUsb3iE94WZAV1gybIZNz4XZKLWg_YHek","_blank");
			});
		$("#lz-saveData").on("click",()=>  { app.SaveSession(); });									// ON SAVE
		$("#lz-exportData").on("click",()=>{ app.ExportSession(); });								// ON EXPORT
		$("#lz-importData").on("click",()=>{ $("#lz-tempFile").trigger("click"); });				// ON IMPORT
		$("#lz-tempFile").on("change",(e)=>{														// ON FILE LOAD
			app.ImportSession(e);																	// Read file
			$("lz-tempFile").val("");																// Clear value		
			});

		
		$(window).on("keydown",function(e) {														// HANDLE KEYPRESS
			if ((e.keyCode == 90) && !e.shiftKey && e.ctrlKey) 	{									// UNDO KEY (Ctrl+Z)  
				if (app.curTable == "schedule")		app.sced.Undo();								// Schedule		
				else if (app.curTable == "venue")	app.ven.Undo();									// Venue
				}
			if (((e.keyCode == 89) && e.ctrlKey) || ((e.keyCode == 90) && e.ctrlKey && e.shiftKey)){ // REDO KEY (Ctrl+Y / Shift+Ctrl+Z)
				if (app.curTable == "schedule")		app.sced.Redo();								// Schedule		
				else if (app.curTable == "venue")	app.ven.Redo();									// Venue
				}
			if ((e.which == 84) && e.altKey && e.ctrlKey) {											// Test key (Ctrl+Alt+T)
				}
		});
	});

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// UI																							    http://js-grid.com
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	$("#lz-tab1").on("click",()=>{ app.curTable="people"; 	$("#lz-tData").css("display","none"); app.LoadSession((s)=>{ trace(s); }); });
	$("#lz-tab2").on("click",()=>{ app.curTable="venue";  	$("#lz-tData").css("display","none");  });
	$("#lz-tab3").on("click",()=>{ app.curTable="schedule"; $("#lz-tData").css("display","none");  });
	$("#lz-tab4").on("click",()=>{ app.curTable="live";  	$("#lz-tData").css("display","none")   });
	$("#lz-tab5").on("click",()=>{ app.curTable="data";  	$("#lz-tData").css("display","block"); });

//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// HELPERS
//////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

	function GetTextBox(title, content, def, callback, x, y)										// GET TEXT LINE BOX
	{
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv' style='text-align:center'></div>");// Add box								
		if (x != undefined)		$("#confirmBoxDiv").css({ left:x+"px", top:y+"px" });					// Position if set
		let str="<img src='img/lizalogo.png' width='64'/><br>";												// Logo					
		str+="<p style='font-size:14px; color:#666'><b>"+title+"</b></p>";
		str+="<p>"+content+"<p>";
		str+="<p><input class='lz-is' style='width:95%' type='text' id='gtBoxTt' value='"+def+"'></p>";
		str+="<div id='dialogOK' class='lz-bs'>OK</div>";
		str+="<div id='dialogCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);																	// Add to div
		$("#gtBoxTt").focus();																			// Focus on button
		$("#gtBoxTt").on("change", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ONE ENTER
		$("#dialogOK").on("click", function() {	callback($("#gtBoxTt").val()); $("#confirmBoxDiv").remove(); });	// ON OK 
		$("#dialogCancel").on("click", function() {	$("#confirmBoxDiv").remove(); });								// ON CANCEL
		}

	function Login(callback)																		// LOG IN
	{
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv'></div>")							// Add box								
		let str=`<img src='img/lizalogo.png' width='64'/>														
		<span style='font-size:16px;float:right'><b>LOG IN</b></span><br><br><table>
		<tr><td>Email</td><td><input class='lz-is' type='text' id='username' name='username'></td></tr>
		<tr><td>Password</td><td><input class='lz-is' type='password' id='password' name='password'></td></tr>
		<tr><td>Session Id &nbsp; </td><td><input class='lz-is' type='text' id='gtBoxId'></td></tr>
		</table><br><div id='dialogOK' class='lz-bs'>Log in</div>`;
		$("#confirmBoxDiv").html(str);																	// Add to div
		if (window.location.host == "localhost") callback=function() {									// Local callback
			app.sessionId=window.location.search.substring(1); 											// Set id
			$("#lz-sessionName").text("SESSION ID: " +app.sessionId);									// Set title
			}
		$("#gtBoxId").on("change", ()=>{																// ON ENTER ID
			callback($("#username").val(),$("#password").val(),$("#gtBoxId").val());					// Send data back
			$("#confirmBoxDiv").remove(); 																// Kill dialog
			});	 
		$("#dialogOK").on("click", ()=>{																// ON OK
			callback($("#username").val(),$("#password").val(),$("#gtBoxId").val());					// Send data back
			$("#confirmBoxDiv").remove(); 																// Kill dialog
			});	 
	}

	function ConfirmBox(title, content, callback, callback2)										// CONFIRMATION BOX
	{
		Sound("ding");																					// Ding sound
		$("#confirmBoxDiv").remove();																	// Remove 
		$("body").append("<div class='lz-confirm' id='confirmBoxDiv'></div>");														
		let str="<img src='img/lizalogo.png' width='64'/><br>";											// Logo					
		str+="<p style='font-size:14px; color:#666'><b>"+title+"</b></p>";
		str+="<p>"+content+"<p>";
		str+="<div style='float:right'><div id='confirmOK' class='lz-bs'>OK</div>";
		str+="<div id='confirmCancel' class='lz-bs' style='margin-left:8px;background-color:#999'>Cancel</div></div>";
		$("#confirmBoxDiv").html(str);	
	
		$("#confirmOK").on("click", function() {														// ON OK BUT
				$("#confirmBoxDiv").remove();															// Remove 
				if (callback)	callback();																// If callback defined, run it
				});

		$("#confirmCancel").on("click", function() {													// ON CANCEL BUT
				$("#confirmBoxDiv").remove();															// Remove 
				if (callback2)	callback2();															// If callback defined, run it
				Sound("delete");																		// Delete sound
				});
	}

	function Sound(sound, mute)															// PLAY SOUND
	{
		var snd=new Audio();																// Init audio object
		if (sound.match(/\.mp3/i))		snd=new Audio(sound)								// If an MP3 file
		else							snd=new Audio("img/"+sound+".mp3");					// Use built in mp3
		if (!mute)	{																		// If not initing or muting	
			snd.volume=50/100;																// Set volume
			snd.play();																		// Play it
			}
	}

	function PopUp(msg, time, div)														// TIMED POPUP
	{
		var str="";
		$("#popupDiv").remove();															// Kill old one, if any
		str+="<div id='popupDiv' class='lz-popup'>"; 										// Add div
		if (time == -1) {																	// If has close but
			time=100000;																	// Increase time
			str+="<img id='pu-close' src='img/closedot.gif' style='float:right;cursor:pointer'>";	// Add close button
			}
		str+=msg+"</div>"; 																	// Add div
		$(div ? "#"+div : "body").append(str);												// Add popup to div or body
		$("#pu-close").click(function() { $("#popupDiv").remove(); });						// Remove on click of close but
		$("#popupDiv").fadeIn(500).delay(time ? time : 2000).fadeOut(500)					// Animate in and out		
	}

	function trace(msg, p1, p2, p3, p4)									
	{
		if (p4 != undefined)
			console.log(msg,p1,p2,p3,p4);
		else if (p3 != undefined)
			console.log(msg,p1,p2,p3);
		else if (p2 != undefined)
			console.log(msg,p1,p2);
		else if (p1 != undefined)
			console.log(msg,p1);
		else
			console.log(msg);
	}

	function GetCookie(cname) 												// GET COOKIE
	{
		let i,c,name=cname+"=";
		let ca=decodeURIComponent(document.cookie).split(';');					// Get cookie array
		for (i=0;i<ca.length;i++) {												// For each cookie
			c=ca[i];
			while (c.charAt(0) == ' ')	c=c.substring(1);
			if (c.indexOf(name) == 0) 	return c.substring(name.length, c.length);
			}
		return "";
	}

///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////
// APP CLASS
///////////////////////////////////////////////////////////////////////////////////////////////////////////////////////////

class App  {																					

	constructor()   																			// CONSTRUCTOR
	{
		app=this;																					// App global pointer
		this.ai=new AI();																			// Alloc AI class	
		this.InitSpreadSheet();																		// Init data spreadsheet
		this.sessionId=window.location.search.substring(1); 										// Set id
		this.sd=[ { type:"INTENT", author:"bferster@stagetools.com", text:"100.1 Giving feedback" } ];																					// Session data
this.sessionId="RER-1";
		this.LoadSession();																			// Load curent session
		}

	InitSpreadSheet()																			// INIT DATA SPREADSHEET
	{
		this.pFields=[{ name:"type", type:"text", width:25, validate:"required"},					// CSV fields
			{ name:"text", type:"text", width:100 },
			{ name:"intent", type:"text", width:25 },
			{ name:"topic", type:"text", width:25},
			{ name:"traits", type:"text",width:50 },
			{ name:"entities", type:"text",width:50 },
			{ type:"control", width:10  }];

		$("#jsGridData").jsGrid({ width:"100%", height:"calc(100vh - 168px)",						// Init JSGrid
				inserting:true, editing:true, sorting:true,
				fields: this.pFields, data:[],
				onItemEditing: function(args) { app.curRow=args.itemIndex;  }
				});
		$("#jsGridData").css("padding",0)		
	}

	LoadSession(callback)																		// LOAD SESSION DATA
	{
		let url="https://viseyes.org/liza/config/loadsession.php?f="+this.sessionId+".json";		// Point at script
		$.ajax({ url:url }).done((d)=> { 															// Load file
			if (d) 			this.sd=JSON.parse(d);													// Objectify
			if  (callback) 	callback() ;															// Run callback if set	
			});		
	}

	SaveSession()																				// SAVE SESSION DATA
	{
		let url="https://viseyes.org/liza/config/savesession.php?f="+this.sessionId+".json";		// Point at script
		let data={ s:JSON.stringify(this.sd) };														// Stringify
		$.ajax({ url:url, type: "POST", method:'POST', data:data })									// Write to file	
			.done((s)=>{ 																			// Done
				if (s == 0)	Sound("delete"),PopUp("Error saving session!");							// Send error 
			 	else		Sound("ding"); 															// Success
				})		
	}

	ExportSession()																				// EXPORT SESSION TO CSV
	{
		let fields=["type","text","intent","topic","traits","entities"];							// Fields
		let data=Papa.unparse(this.sd,{ header:true, skipEmptyLines:true, columns:fields });		// Make CSV using lib
		let textFileAsBlob=new Blob([data], {type:'text/plain'});									// Get blob
		let downloadLink=document.createElement("a");												// Fake link
		downloadLink.download=app.sessionId+".csv";													// Filename
		downloadLink.innerHTML="Download File";														// Fake html														
		downloadLink.href=window.URL.createObjectURL(textFileAsBlob);								// Payload
		downloadLink.style.display="none";															// Hide
		downloadLink.id="tdll";																		// Id
		downloadLink.onclick=()=>{ downloadLink.remove(); };										// On click, remove fake link
		document.body.appendChild(downloadLink);													// Add to DOM
		downloadLink.click();																		// Trigger fake link
	}
	
	ImportSession(e)																			// IMPORT SESSION FROM CSV
	{	
		let i,k;
		let file=e.target.files[0];																	// Point at file
		if (!file) 	return;																			// Quit if bad
		let reader=new FileReader();																// Init reader
		reader.readAsText(file);																	// Read file
		reader.onload=(e)=>{ 																		// When loaded
			this.sd=Papa.parse(e.target.result, { header:true, skipEmptyLines:true }).data;			// Parse CSV using papa lib
			for (i=0;i<this.sd.length;++i)															// For each line
				for (k in this.sd[i]) if (!k) delete this.sd[i][k];									// If empty field, delete it
			Sound("ding");																			// Ding
			};
	}

	Login()																						// LOGIN
	{
	}

} // App class closure


</script>
</body>
</html>
